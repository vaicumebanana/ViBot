<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ViBot - Assistente Virtual</title>
<style>
  :root {
    --primary: #4f46e5;
    --user-bg: #4f46e5;
    --bot-bg: #f3f4f6;
    --error-bg: #fee2e2;
    --text: #111827;
    --error-text: #dc2626;
    --bg: #f9fafb;
  }
  [data-theme="dark"] {
    --bg: #1f2937;
    --bot-bg: #374151;
    --text: #f9fafb;
  }
  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0; padding: 0;
    transition: background 0.3s, color 0.3s;
  }
  header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 32px; background: white; border-bottom: 1px solid #e5e7eb;
  }
  [data-theme="dark"] header { background: #111827; }
  h1 { margin: 0; color: var(--primary); }
  header div { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  button, select {
    font-size: 14px;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    background: white;
    cursor: pointer;
  }
  button:hover:not(:disabled) { opacity: 0.9; }
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  main { display: flex; max-width: 1100px; margin: 20px auto; gap: 20px; padding: 0 20px; }
  #chat-container { flex: 1; display: flex; flex-direction: column; }
  #chatbox {
    background: white; border: 1px solid #e5e7eb; border-radius: 12px;
    flex: 1; padding: 16px; overflow-y: auto;
    display: flex; flex-direction: column; gap: 12px;
    min-height: 300px;
  }
  .message {
    padding: 12px 16px; border-radius: 12px; max-width: 85%;
    line-height: 1.5; animation: fadeIn 0.3s ease-out;
    word-wrap: break-word; white-space: pre-wrap;
  }
  .user { background: var(--user-bg); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
  .bot { background: var(--bot-bg); color: var(--text); align-self: flex-start; border-bottom-left-radius: 4px; }
  .error { background: var(--error-bg); color: var(--error-text); align-self: center; text-align: center; }
  .typing { color: #6b7280; font-style: italic; animation: blink 1s steps(1) infinite; }
  @keyframes fadeIn { from {opacity:0;transform:translateY(10px);} to {opacity:1;transform:translateY(0);} }
  @keyframes blink { 50% {opacity:0.5;} }
  #input-container { display: flex; gap: 12px; margin-top: 12px; }
  #userInput {
    flex: 1; padding: 12px 16px; border: 1px solid #e5e7eb;
    border-radius: 12px; font-size: 16px;
    resize: none;
    min-height: 40px;
  }
  #sendBtn {
    background: var(--primary); color: white; border: none;
    border-radius: 12px; padding: 0 24px; font-weight: 500;
    cursor: pointer; transition: background-color 0.2s;
    white-space: nowrap;
  }
  #sendBtn:hover:not(:disabled) { background: #4338ca; }
  #sendBtn:disabled { background: #9ca3af; cursor: not-allowed; }
  aside {
    width: 250px; background: white; border: 1px solid #e5e7eb;
    border-radius: 12px; padding: 16px; display: flex;
    flex-direction: column; gap: 12px;
  }
  #newConversationBtn {
    background: var(--primary); color: white; border: none;
    border-radius: 12px; padding: 12px; font-weight: 600;
    cursor: pointer; transition: background-color 0.2s;
  }
  #newConversationBtn:hover { background: #4338ca; }
  #conversationList {
    overflow-y: auto; flex: 1;
    display: flex; flex-direction: column; gap: 8px;
  }
  .conversation-btn {
    background: #f3f4f6; border: none; border-radius: 8px;
    padding: 8px 12px; font-size: 14px; color: var(--text);
    text-align: left; white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis; cursor: pointer;
    transition: background-color 0.2s;
  }
  .conversation-btn:hover { background: var(--primary); color: white; }
  .conversation-btn.active { background: var(--primary); color: white; font-weight: 700; }
  @media(max-width:768px) {
    main { flex-direction: column; }
    aside { width:100%; margin-bottom:20px; order:-1; }
    #chatbox { height:50vh; }
    #input-container { flex-direction:column; }
    #sendBtn { width:100%; }
  }
</style>
</head>
<body>
<header>
  <h1>ViBot</h1>
  <div>
    <button id="toggleTheme" aria-label="Alternar tema">üåì Tema</button>
    <button id="startSpeech" aria-label="Ativar/desativar voz" style="opacity: 0.5;">üéôÔ∏è Voz</button>
    <button id="exportHistory" aria-label="Exportar hist√≥rico">üìÇ Exportar</button>
    <button id="importHistory" aria-label="Importar hist√≥rico">üìÅ Importar</button>
    <select id="languageSelector" aria-label="Selecionar idioma">
      <option value="pt-BR" selected>Portugu√™s</option>
      <option value="en-US">English</option>
      <option value="es-ES">Espa√±ol</option>
      <option value="zh-CN">‰∏≠Êñá</option>
      <option value="hi-IN">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
      <option value="ar-SA">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
      <option value="fr-FR">Fran√ßais</option>
      <option value="ru-RU">–†—É—Å—Å–∫–∏–π</option>
    </select>
  </div>
</header>

<main>
  <div id="chat-container">
    <div id="chatbox" role="log" aria-live="polite" aria-atomic="false"></div>
    <div id="input-container">
      <textarea id="userInput" placeholder="Digite sua mensagem..." autocomplete="off" rows="1"></textarea>
      <button id="sendBtn" aria-label="Enviar mensagem" disabled>üì© Enviar</button>
    </div>
  </div>
  <aside>
    <button id="newConversationBtn" aria-label="Nova conversa">‚ûï Nova Conversa</button>
    <div id="conversationList" aria-label="Lista de conversas"></div>
  </aside>
</main>

<input type="file" id="importFile" accept=".txt" style="display: none;" aria-hidden="true" />

<script>
  const ViBot = {
    config: {
      apiUrl: "https://api.groq.com/openai/v1/chat/completions",
      apiKey: "gsk_GAB1Wl5zqbp30qPDeMObWGdyb3FY0g7KiTlGt5aWhUnkD495Bi3T",
      model: "llama3-70b-8192",
      temperature: 0.7,
      maxTokens: 1024
    },

    init() {
      // Elementos
      this.chatbox = document.getElementById("chatbox");
      this.userInput = document.getElementById("userInput");
      this.sendBtn = document.getElementById("sendBtn");
      this.newConversationBtn = document.getElementById("newConversationBtn");
      this.conversationList = document.getElementById("conversationList");
      this.languageSelector = document.getElementById("languageSelector");
      this.toggleThemeBtn = document.getElementById("toggleTheme");
      this.startSpeechBtn = document.getElementById("startSpeech");
      this.exportHistoryBtn = document.getElementById("exportHistory");
      this.importHistoryBtn = document.getElementById("importHistory");
      this.importFileInput = document.getElementById("importFile");

      this.speaking = false;
      this.speechSynthesis = window.speechSynthesis;
      this.currentUtterance = null;

      this.typingIndicator = document.createElement("div");
      this.typingIndicator.className = "message bot typing";
      this.typingIndicator.textContent = "ViBot est√° digitando...";

      this.loadTheme();
      this.loadConversations();

      if (!this.currentConversationId || !this.conversations[this.currentConversationId]) {
        this.createNewConversation();
      } else {
        this.renderConversationsList();
        this.renderCurrentConversation();
      }

      // Eventos
      this.sendBtn.onclick = () => this.sendMessage();

      // Habilita/desabilita bot√£o enviar conforme o input
      this.userInput.addEventListener("input", () => {
        this.sendBtn.disabled = this.userInput.value.trim().length === 0;
        this.adjustTextareaHeight();
      });

      // Enviar com Enter (shift + enter insere nova linha)
      this.userInput.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          if (!this.sendBtn.disabled) this.sendMessage();
        }
      });

      this.newConversationBtn.onclick = () => this.createNewConversation();
      this.toggleThemeBtn.onclick = () => this.toggleTheme();
      this.startSpeechBtn.onclick = () => this.toggleSpeech();
      this.exportHistoryBtn.onclick = () => this.exportHistory();
      this.importHistoryBtn.onclick = () => this.importFileInput.click();
      this.importFileInput.onchange = e => this.importHistory(e);
      this.languageSelector.onchange = e => this.changeLanguage(e.target.value);

      this.adjustTextareaHeight();
    },

    conversations: {},
    currentConversationId: null,

    loadConversations() {
      const data = localStorage.getItem("vibot_conversations");
      if (data) {
        try {
          this.conversations = JSON.parse(data);
          this.currentConversationId = localStorage.getItem("vibot_current");
        } catch {
          this.conversations = {};
          this.currentConversationId = null;
        }
      }
    },

    saveConversations() {
      localStorage.setItem("vibot_conversations", JSON.stringify(this.conversations));
      localStorage.setItem("vibot_current", this.currentConversationId);
    },

    createNewConversation() {
      const id = "conv_" + Date.now();
      this.conversations[id] = {
        id,
        messages: []
      };
      this.currentConversationId = id;
      this.saveConversations();
      this.renderConversationsList();
      this.renderCurrentConversation();
      this.userInput.focus();
      this.sendBtn.disabled = true;
    },

    renderConversationsList() {
      this.conversationList.innerHTML = "";
      for (const id in this.conversations) {
        const conv = this.conversations[id];
        const firstMsg = conv.messages.find(m => m.role === "user" || m.role === "assistant");
        const previewText = firstMsg
          ? firstMsg.content.substring(0, 30).replace(/\n/g, " ") + (firstMsg.content.length > 30 ? "..." : "")
          : "Nova conversa";
        const btn = document.createElement("button");
        btn.textContent = previewText;
        btn.className = "conversation-btn" + (id === this.currentConversationId ? " active" : "");
        btn.title = previewText;
        btn.onclick = () => {
          this.currentConversationId = id;
          this.saveConversations();
          this.renderConversationsList();
          this.renderCurrentConversation();
          this.userInput.focus();
          this.sendBtn.disabled = this.userInput.value.trim().length === 0;
        };
        this.conversationList.appendChild(btn);
      }
    },

    renderCurrentConversation() {
      this.chatbox.innerHTML = "";
      const conv = this.conversations[this.currentConversationId];
      if (!conv) return;
      for (const msg of conv.messages) {
        this.addMessageToChatbox(msg.role, msg.content);
      }
      this.scrollChatToBottom();
    },

    addMessageToChatbox(role, content) {
      const div = document.createElement("div");
      div.className = "message " + (role === "user" ? "user" : "bot");
      div.textContent = content;
      this.chatbox.appendChild(div);
    },

    addErrorMessage(error) {
      const div = document.createElement("div");
      div.className = "message error";
      div.textContent = "Erro: " + error;
      this.chatbox.appendChild(div);
      this.scrollChatToBottom();
    },

    scrollChatToBottom() {
      this.chatbox.scrollTop = this.chatbox.scrollHeight;
    },

    async sendMessage() {
      let text = this.userInput.value.trim();
      if (!text) return;

      this.userInput.value = "";
      this.sendBtn.disabled = true;
      this.userInput.disabled = true;

      this.addMessageToChatbox("user", text);
      this.conversations[this.currentConversationId].messages.push({ role: "user", content: text });
      this.saveConversations();

      this.chatbox.appendChild(this.typingIndicator);
      this.scrollChatToBottom();

      try {
        const responseText = await this.callApi(this.conversations[this.currentConversationId].messages);
        this.chatbox.removeChild(this.typingIndicator);
        this.addMessageToChatbox("assistant", responseText);
        this.conversations[this.currentConversationId].messages.push({ role: "assistant", content: responseText });
        this.saveConversations();
        this.scrollChatToBottom();

        if (this.speaking) this.speakText(responseText);

      } catch (error) {
        this.chatbox.removeChild(this.typingIndicator);
        this.addErrorMessage(error.message || "Erro desconhecido");
      } finally {
        this.userInput.disabled = false;
        this.userInput.focus();
        this.sendBtn.disabled = this.userInput.value.trim().length === 0;
      }
    },

    async callApi(messages) {
      // Para compatibilidade, uso fetch e envio a conversa completa.
      const payload = {
        model: this.config.model,
        messages: messages,
        temperature: this.config.temperature,
        max_tokens: this.config.maxTokens
      };

      const response = await fetch(this.config.apiUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + this.config.apiKey
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        let errMsg = `HTTP ${response.status}`;
        try {
          const errJson = await response.json();
          if (errJson.error) errMsg = errJson.error.message || errMsg;
        } catch {}
        throw new Error(errMsg);
      }

      const data = await response.json();

      if (!data.choices || !data.choices.length) {
        throw new Error("Resposta inv√°lida da API");
      }

      const text = data.choices[0].message.content.trim();
      return text;
    },

    toggleTheme() {
      const current = document.documentElement.getAttribute("data-theme");
      if (current === "dark") {
        document.documentElement.removeAttribute("data-theme");
        localStorage.setItem("vibot_theme", "light");
      } else {
        document.documentElement.setAttribute("data-theme", "dark");
        localStorage.setItem("vibot_theme", "dark");
      }
    },

    loadTheme() {
      const theme = localStorage.getItem("vibot_theme");
      if (theme === "dark") {
        document.documentElement.setAttribute("data-theme", "dark");
      } else {
        document.documentElement.removeAttribute("data-theme");
      }
    },

    toggleSpeech() {
      if (!("speechSynthesis" in window)) {
        alert("Seu navegador n√£o suporta s√≠ntese de voz.");
        return;
      }

      this.speaking = !this.speaking;

      if (this.speaking) {
        this.startSpeechBtn.style.opacity = "1";
      } else {
        this.startSpeechBtn.style.opacity = "0.5";
        if (this.currentUtterance) {
          this.speechSynthesis.cancel();
          this.currentUtterance = null;
        }
      }
    },

    speakText(text) {
      if (!this.speaking) return;
      if (!("speechSynthesis" in window)) return;

      if (this.currentUtterance) {
        this.speechSynthesis.cancel();
        this.currentUtterance = null;
      }

      const utterance = new SpeechSynthesisUtterance(text);

      // Tenta ajustar voz para o idioma selecionado
      const lang = this.languageSelector.value || "pt-BR";
      utterance.lang = lang;

      // Ajuste voz: tentar escolher uma voz que combine com o idioma
      const voices = this.speechSynthesis.getVoices();
      const voice = voices.find(v => v.lang.toLowerCase().startsWith(lang.toLowerCase()));
      if (voice) utterance.voice = voice;

      utterance.rate = 1;
      utterance.pitch = 1;

      this.currentUtterance = utterance;

      this.speechSynthesis.speak(utterance);
    },

    exportHistory() {
      if (!this.currentConversationId) return;
      const conv = this.conversations[this.currentConversationId];
      if (!conv) return;

      let text = "";
      for (const msg of conv.messages) {
        text += (msg.role === "user" ? "Usu√°rio: " : "ViBot: ") + msg.content + "\n\n";
      }

      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `vibot_conversa_${this.currentConversationId}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    },

    importHistory(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const content = e.target.result;
        // Cria nova conversa com o conte√∫do
        const id = "conv_" + Date.now();
        const messages = [];

        // Tenta parsear o texto simples para mensagens
        // Exemplo: "Usu√°rio: texto\n\nViBot: texto\n\n..."
        const lines = content.split(/\r?\n/);
        let role = null;
        let buffer = "";

        for (const line of lines) {
          if (line.startsWith("Usu√°rio:")) {
            if (buffer && role) {
              messages.push({ role, content: buffer.trim() });
              buffer = "";
            }
            role = "user";
            buffer = line.replace("Usu√°rio:", "").trim();
          } else if (line.startsWith("ViBot:")) {
            if (buffer && role) {
              messages.push({ role, content: buffer.trim() });
              buffer = "";
            }
            role = "assistant";
            buffer = line.replace("ViBot:", "").trim();
          } else if (line.trim() === "") {
            if (buffer && role) {
              messages.push({ role, content: buffer.trim() });
              buffer = "";
              role = null;
            }
          } else {
            if (buffer !== "") buffer += "\n" + line;
            else buffer = line;
          }
        }
        if (buffer && role) {
          messages.push({ role, content: buffer.trim() });
        }

        this.conversations[id] = { id, messages };
        this.currentConversationId = id;
        this.saveConversations();
        this.renderConversationsList();
        this.renderCurrentConversation();

        this.userInput.value = "";
        this.sendBtn.disabled = true;
      };
      reader.readAsText(file);
      // Limpar input para permitir importar mesmo arquivo novamente
      event.target.value = "";
    },

    changeLanguage(lang) {
      // Atualiza idioma para voz e placeholders
      this.userInput.placeholder = {
        "pt-BR": "Digite sua mensagem...",
        "en-US": "Type your message...",
        "es-ES": "Escribe tu mensaje...",
        "zh-CN": "ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÊ∂àÊÅØ...",
        "hi-IN": "‡§Ö‡§™‡§®‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≤‡§ø‡§ñ‡•á‡§Ç...",
        "ar-SA": "ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ...",
        "fr-FR": "Tapez votre message...",
        "ru-RU": "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
      }[lang] || "Digite sua mensagem...";
    },

    adjustTextareaHeight() {
      const ta = this.userInput;
      ta.style.height = "auto";
      ta.style.height = ta.scrollHeight + "px";
    }
  };

  window.addEventListener("DOMContentLoaded", () => {
    ViBot.init();
  });
</script>

</body>
</html>
