<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ViBot 2.0 - Assistente Virtual Multil√≠ngue com Voz</title>
  <style>
    :root {
      --bg-light: #f9fafb;
      --bg-dark: #1f2937;
      --text-light: #111827;
      --text-dark: #f9fafb;
      --primary: #4f46e5;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-light);
      color: var(--text-light);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    [data-theme="dark"] {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    header {
      background: white;
      padding: 16px;
      border-bottom: 1px solid #ccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    [data-theme="dark"] header {
      background: #111827;
      color: white;
      border-color: #444;
    }

    h1 {
      color: var(--primary);
      margin: 0;
      font-weight: 700;
      font-size: 1.5rem;
    }

    #controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    button, select, input[type="file"] {
      margin: 4px 0;
      padding: 10px 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      background: #f3f4f6;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    button:hover, select:hover {
      background: #e5e7eb;
    }

    [data-theme="dark"] button, [data-theme="dark"] select {
      background: #374151;
      border-color: #555;
      color: var(--text-dark);
    }

    [data-theme="dark"] button:hover, [data-theme="dark"] select:hover {
      background: #4b5563;
    }

    #chatbox {
      padding: 16px;
      flex-grow: 1;
      max-width: 800px;
      margin: 10px auto;
      background: white;
      min-height: 300px;
      border: 1px solid #ddd;
      border-radius: 10px;
      overflow-y: auto;
      box-sizing: border-box;
      width: 90%;
      scroll-behavior: smooth;
    }

    [data-theme="dark"] #chatbox {
      background: #2d3748;
      border-color: #444;
    }

    .message {
      padding: 10px;
      margin: 6px 0;
      border-radius: 8px;
      max-width: 70%;
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.3em;
      font-size: 1rem;
    }

    .user {
      background: var(--primary);
      color: white;
      margin-left: auto;
      text-align: right;
    }

    .bot {
      background: #e0e7ff;
      color: #111827;
      margin-right: auto;
    }

    [data-theme="dark"] .bot {
      background: #4b5563;
      color: white;
    }

    #inputRow {
      display: flex;
      gap: 10px;
      max-width: 800px;
      margin: 0 auto 20px;
      padding: 0 16px;
      flex-shrink: 0;
      width: 90%;
    }

    #userInput {
      flex: 1;
      padding: 10px 14px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      resize: vertical;
      min-height: 48px;
    }

    [data-theme="dark"] #userInput {
      background: #1f2937;
      border-color: #555;
      color: var(--text-dark);
    }

    #sendBtn {
      background: var(--primary);
      color: white;
      border: none;
      font-weight: 600;
      min-width: 90px;
    }

    #sendBtn:hover {
      background: #4338ca;
    }

    #sendBtn:disabled {
      background: #a5b4fc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <header>
    <h1>ViBot 2.0</h1>
    <div id="controls">
      <button id="toggleTheme" aria-label="Alternar tema claro/escuro">üåì Tema</button>
      <button id="voiceInputBtn" aria-label="Ativar entrada de voz">üéôÔ∏è Falar</button>
      <button id="exportHistory" aria-label="Exportar hist√≥rico">üìÇ Exportar</button>
      <button id="importHistory" aria-label="Importar hist√≥rico">üìÅ Importar</button>
      <select id="languageSelector" aria-label="Selecionar idioma da conversa" title="Selecionar idioma da conversa">
        <option value="pt">Portugu√™s</option>
        <option value="en">English</option>
        <option value="es">Espa√±ol</option>
        <option value="fr">Fran√ßais</option>
        <option value="de">Deutsch</option>
        <option value="it">Italiano</option>
        <option value="ja">Êó•Êú¨Ë™û</option>
        <option value="zh">‰∏≠Êñá</option>
      </select>
      <input type="file" id="importFile" accept=".txt" style="display:none;" />
    </div>
  </header>

  <main>
    <div id="chatbox" role="log" aria-live="polite" aria-label="√Årea de conversa do ViBot"></div>

    <div id="inputRow">
      <textarea id="userInput" rows="2" placeholder="Digite sua mensagem..." autocomplete="off" aria-label="Campo para digitar mensagem"></textarea>
      <button id="sendBtn" aria-label="Enviar mensagem">üì© Enviar</button>
    </div>
  </main>

  <script>
    // --- Vari√°veis e refer√™ncias ---
    const chatbox = document.getElementById('chatbox');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const toggleThemeBtn = document.getElementById('toggleTheme');
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    const exportHistoryBtn = document.getElementById('exportHistory');
    const importHistoryBtn = document.getElementById('importHistory');
    const importFileInput = document.getElementById('importFile');
    const languageSelector = document.getElementById('languageSelector');

    let recognition = null;
    let recognizing = false;
    let synth = window.speechSynthesis;
    let isSpeaking = false;

    // Hist√≥rico de conversa: array de objetos {role:'user'|'bot', text:string}
    let history = [];

    // Tema inicial do sistema
    const savedTheme = localStorage.getItem('vibot-theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    // Idioma inicial
    const savedLang = localStorage.getItem('vibot-lang') || 'pt';
    languageSelector.value = savedLang;

    // Atualizar bot√µes e estado
    function updateSendBtnState() {
      sendBtn.disabled = userInput.value.trim() === '';
    }

    // Renderizar mensagem no chat
    function addMessage(role, text) {
      const div = document.createElement('div');
      div.className = 'message ' + (role === 'user' ? 'user' : 'bot');
      div.textContent = text;
      chatbox.appendChild(div);
      chatbox.scrollTop = chatbox.scrollHeight;
      history.push({ role, text });
      saveHistory();
    }

    // Salvar hist√≥rico no localStorage
    function saveHistory() {
      localStorage.setItem('vibot-history', JSON.stringify(history));
    }

    // Carregar hist√≥rico do localStorage
    function loadHistory() {
      const saved = localStorage.getItem('vibot-history');
      if (saved) {
        try {
          history = JSON.parse(saved);
          history.forEach(m => addMessage(m.role, m.text));
        } catch {
          history = [];
        }
      }
    }

    // Limpar hist√≥rico na tela (sem apagar localStorage)
    function clearChat() {
      chatbox.innerHTML = '';
    }

    // Traduz texto de sourceLang para targetLang usando API p√∫blica LibreTranslate
    async function translateText(text, sourceLang, targetLang) {
      if (!text.trim() || sourceLang === targetLang) return text;

      try {
        const response = await fetch('https://libretranslate.de/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            q: text,
            source: sourceLang,
            target: targetLang,
            format: "text"
          })
        });
        const data = await response.json();
        return data.translatedText || text;
      } catch (e) {
        console.warn('Falha na tradu√ß√£o, enviando texto original:', e);
        return text;
      }
    }

    // Simula envio para API Groq (ou substitua aqui sua chamada real)
    // Exemplo b√°sico: resposta bot = "Voc√™ disse: " + texto em portugu√™s
    async function sendToGroqAPI(textInPortuguese) {
      // Aqui voc√™ colocaria seu fetch para a API Groq real, por enquanto simulo delay + resposta
      return new Promise(resolve => {
        setTimeout(() => {
          resolve('Resposta da API (simulada): Voc√™ disse "' + textInPortuguese + '"');
        }, 1200);
      });
    }

    // Fun√ß√£o principal de envio da mensagem
    async function handleSend() {
      let text = userInput.value.trim();
      if (!text) return;

      // Adiciona a mensagem do usu√°rio direto no chat (no idioma selecionado)
      addMessage('user', text);
      userInput.value = '';
      updateSendBtnState();

      const selectedLang = languageSelector.value;
      try {
        // 1) Traduz do idioma selecionado para portugu√™s para a API
        const textInPortuguese = await translateText(text, selectedLang, 'pt');

        // 2) Envia texto em portugu√™s para a API Groq
        const botResponseInPortuguese = await sendToGroqAPI(textInPortuguese);

        // 3) Traduz resposta da API para o idioma do usu√°rio
        const botResponse = await translateText(botResponseInPortuguese, 'pt', selectedLang);

        // 4) Exibe resposta do bot
        addMessage('bot', botResponse);

        // 5) Se voz estiver ativada, fala a resposta
        if (voiceEnabled) speakText(botResponse, selectedLang);
      } catch (error) {
        addMessage('bot', 'Erro ao processar a mensagem. Tente novamente.');
        console.error(error);
      }
    }

    // Ativar/desativar tema
    toggleThemeBtn.onclick = () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('vibot-theme', newTheme);
    };

    // Habilitar/desabilitar bot√£o enviar com base no input
    userInput.addEventListener('input', updateSendBtnState);

    sendBtn.addEventListener('click', handleSend);

    userInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!sendBtn.disabled) {
          handleSend();
        }
      }
    });

    // --- Entrada por voz ---
    let voiceEnabled = false;

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = languageSelector.value;
      recognition.interimResults = false;
      recognition.continuous = false;

      recognition.onstart = () => {
        recognizing = true;
        voiceInputBtn.textContent = 'üõë Parar';
        voiceInputBtn.style.backgroundColor = '#ef4444'; // vermelho
      };

      recognition.onend = () => {
        recognizing = false;
        voiceInputBtn.textContent = 'üéôÔ∏è Falar';
        voiceInputBtn.style.backgroundColor = '';
      };

      recognition.onerror = event => {
        recognizing = false;
        voiceInputBtn.textContent = 'üéôÔ∏è Falar';
        voiceInputBtn.style.backgroundColor = '';
        console.error('Erro no reconhecimento de voz:', event.error);
      };

      recognition.onresult = event => {
        const transcript = event.results[0][0].transcript;
        userInput.value += (userInput.value ? ' ' : '') + transcript;
        updateSendBtnState();
      };

      voiceInputBtn.addEventListener('click', () => {
        if (recognizing) {
          recognition.stop();
          recognizing = false;
        } else {
          recognition.lang = languageSelector.value;
          recognition.start();
        }
      });
    } else {
      voiceInputBtn.disabled = true;
      voiceInputBtn.title = 'Reconhecimento de voz n√£o suportado neste navegador.';
    }

    // --- Sa√≠da de voz ---
    function speakText(text, lang) {
      if (!('speechSynthesis' in window)) return;

      if (synth.speaking) {
        synth.cancel();
      }

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = langMapToBcp47(lang);
      synth.speak(utterance);
    }

    // Mapear c√≥digo do seletor para BCP47 usado no SpeechSynthesis
    function langMapToBcp47(lang) {
      const map = {
        pt: 'pt-BR',
        en: 'en-US',
        es: 'es-ES',
        fr: 'fr-FR',
        de: 'de-DE',
        it: 'it-IT',
        ja: 'ja-JP',
        zh: 'zh-CN'
      };
      return map[lang] || 'pt-BR';
    }

    // Ativar/desativar voz com toggle (clicar no microfone ativa voz)
    // No momento, bot√£o s√≥ ativa input por voz

    // --- Exportar hist√≥rico ---
    exportHistoryBtn.addEventListener('click', () => {
      if (!history.length) {
        alert('Hist√≥rico vazio para exportar.');
        return;
      }
      const textToExport = history.map(m => (m.role === 'user' ? 'Usu√°rio: ' : 'Bot: ') + m.text).join('\n\n');
      const blob = new Blob([textToExport], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'vibot-historico.txt';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // --- Importar hist√≥rico ---
    importHistoryBtn.addEventListener('click', () => {
      importFileInput.click();
    });

    importFileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        const content = e.target.result;
        // Simples parse: linha iniciando com "Usu√°rio: " ou "Bot: "
        const lines = content.split(/\r?\n/);
        clearChat();
        history = [];
        for (let line of lines) {
          if (line.startsWith('Usu√°rio: ')) {
            addMessage('user', line.replace('Usu√°rio: ', '').trim());
          } else if (line.startsWith('Bot: ')) {
            addMessage('bot', line.replace('Bot: ', '').trim());
          }
        }
        saveHistory();
      };
      reader.readAsText(file, 'UTF-8');
      importFileInput.value = ''; // reset input
    });

    // Ao mudar idioma, atualiza reconhecimento de voz
    languageSelector.addEventListener('change', () => {
      localStorage.setItem('vibot-lang', languageSelector.value);
      if (recognition && recognizing) {
        recognition.stop();
      }
    });

    // Inicializa√ß√µes
    function init() {
      updateSendBtnState();
      loadHistory();
    }

    init();

  </script>
</body>
</html>
