<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ViBot - Assistente Virtual</title>
  <style>
    /* (estilos mantidos conforme sua versão anterior, não removidos para brevidade) */
  </style>
</head>
<body>
  <header>
    <h1>ViBot</h1>
    <div>
      <button id="toggleTheme">🌓 Tema</button>
      <button id="startSpeech">🎙️ Voz</button>
      <button id="exportHistory">📂 Exportar</button>
      <button id="importHistory">📁 Importar</button>
      <select id="languageSelector">
        <option value="pt" selected>Português</option>
        <option value="en">English</option>
        <option value="es">Español</option>
        <option value="zh">中文</option>
        <option value="hi">हिन्दी</option>
        <option value="ar">العربية</option>
        <option value="fr">Français</option>
        <option value="ru">Русский</option>
      </select>
    </div>
  </header>

  <main>
    <div id="chat-container">
      <div id="chatbox" role="log" aria-live="polite"></div>
      <div id="input-container">
        <input id="userInput" placeholder="Digite sua mensagem..." />
        <button id="sendBtn">📩 Enviar</button>
      </div>
    </div>
    <aside>
      <button id="newConversationBtn">➕ Nova Conversa</button>
      <div id="conversationList"></div>
    </aside>
  </main>

  <!-- Input oculto para importar arquivo -->
  <input type="file" id="importFile" accept=".txt" style="display: none;" />

  <script>
    const ViBot = {
      config: {
        apiUrl: "https://api.groq.com/openai/v1/chat/completions",
        apiKey: "gsk_GAB1Wl5zqbp30qPDeMObWGdyb3FY0g7KiTlGt5aWhUnkD495Bi3T", // ⚠️ Substitua por sua chave
        model: "llama3-70b-8192",
        temperature: 0.7,
        maxTokens: 1024
      },
      init() {
        const ids = ["chatbox", "userInput", "sendBtn", "newConversationBtn", "conversationList", "languageSelector", "toggleTheme", "startSpeech", "exportHistory", "importHistory", "importFile"];
        ids.forEach(id => this[id] = document.getElementById(id));
        this.typingIndicator = Object.assign(document.createElement("div"), {
          className: "message bot typing",
          textContent: "ViBot está digitando..."
        });
        this.loadTheme();
        this.loadConversations();
        if (!this.currentConversationId) this.createNewConversation();
        else this.renderConversationsList(), this.renderCurrentConversation();

        this.sendBtn.onclick = () => this.sendMessage();
        this.userInput.onkeydown = e => { if (e.key === "Enter") { e.preventDefault(); this.sendMessage(); }};
        this.newConversationBtn.onclick = () => this.createNewConversation();
        this.toggleTheme.onclick = () => this.toggleTheme();
        this.exportHistory.onclick = () => this.exportCurrent();
        this.startSpeech.onclick = () => this.toggleVoice();
        this.importHistory.onclick = () => this.importFile.click();
        this.importFile.onchange = e => this.importConversation(e.target.files[0]);
      },
      /* Theme */
      loadTheme() {
        const t = localStorage.getItem('vibot_theme') || 'light';
        document.documentElement.setAttribute('data-theme', t);
      },
      toggleTheme() {
        const cur = document.documentElement.getAttribute('data-theme');
        const nxt = cur === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', nxt);
        localStorage.setItem('vibot_theme', nxt);
      },
      /* Voice */
      toggleVoice() {
        if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
          return alert('Reconhecimento de voz não suportado.');
        }
        if (this.recognizer) {
          this.recognizer.stop();
          this.recognizer = null;
          this.startSpeech.textContent = '🎙️ Voz';
        } else {
          const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
          this.recognizer = new SR();
          this.recognizer.lang = this.languageSelector.value;
          this.recognizer.interimResults = false;
          this.recognizer.start();
          this.startSpeech.textContent = '🛑 Parar';
          this.recognizer.onresult = e => {
            this.userInput.value = e.results[0][0].transcript;
            this.sendMessage();
          };
          this.recognizer.onerror = () => {
            this.recognizer.stop();
            this.recognizer = null;
            this.startSpeech.textContent = '🎙️ Voz';
          };
        }
      },
      speak(text) {
        if ('speechSynthesis' in window) {
          const ut = new SpeechSynthesisUtterance(text);
          ut.lang = this.languageSelector.value;
          speechSynthesis.speak(ut);
        }
      },
      exportCurrent() {
        const conv = this.conversations[this.currentConversationId] || [];
        const txt = conv.map(m => (m.role === 'user' ? 'Você: ' : 'ViBot: ') + m.content).join('\n');
        const blob = new Blob([txt], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'vibot_conversa.txt';
        a.click();
        URL.revokeObjectURL(a.href);
      },
      importConversation(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const content = reader.result;
          const lines = content.split(/\r?\n/).filter(line => line.trim() !== "");
          const messages = [];
          for (let line of lines) {
            if (line.startsWith("Você: ")) {
              messages.push({ role: "user", content: line.replace("Você: ", "").trim() });
            } else if (line.startsWith("ViBot: ")) {
              messages.push({ role: "bot", content: line.replace("ViBot: ", "").trim() });
            }
          }
          if (messages.length > 0) {
            const id = "conv_" + Date.now();
            this.conversations[id] = messages;
            this.currentConversationId = id;
            this.saveConversations();
            this.renderConversationsList();
            this.renderCurrentConversation();
            alert("Conversa importada com sucesso!");
          } else {
            alert("Formato inválido. Use um .txt no estilo:\nVocê: ...\nViBot: ...");
          }
        };
        reader.readAsText(file);
      },
      async sendMessage() {
        const prompt = this.userInput.value.trim();
        if (!prompt) return;
        this.sendBtn.disabled = true;
        this.addMessage(prompt, "user");
        this.conversations[this.currentConversationId].push({ role: "user", content: prompt });
        this.saveConversations();
        this.chatbox.appendChild(this.typingIndicator);
        this.chatbox.scrollTop = this.chatbox.scrollHeight;
        try {
          const sys = this.getSystemPrompt(this.languageSelector.value);
          const body = {
            model: this.config.model,
            messages: [{ role: "system", content: sys }, ...this.conversations[this.currentConversationId]],
            temperature: this.config.temperature,
            max_tokens: this.config.maxTokens
          };
          const res = await fetch(this.config.apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${this.config.apiKey}`
            },
            body: JSON.stringify(body)
          });

          const contentType = res.headers.get("content-type");
          let data;
          if (contentType && contentType.includes("application/json")) {
            data = await res.json();
          } else {
            const text = await res.text();
            throw new Error(`Resposta não JSON: ${text.slice(0, 200)}`);
          }

          if (!res.ok) {
            throw new Error(`Erro ${res.status}: ${data.error?.message || JSON.stringify(data)}`);
          }

          const bot = data.choices?.[0]?.message?.content?.trim();
          if (!bot) throw new Error("Resposta vazia");

          this.chatbox.removeChild(this.typingIndicator);
          this.addMessage(bot, "bot");
          this.conversations[this.currentConversationId].push({ role: "bot", content: bot });
          this.speak(bot);
          this.saveConversations();
        } catch (e) {
          this.chatbox.removeChild(this.typingIndicator);
          this.addMessage("Erro: " + e.message, "error");
          this.conversations[this.currentConversationId].push({ role: "error", content: e.message });
          this.saveConversations();
          console.error(e);
        } finally {
          this.sendBtn.disabled = false;
          this.userInput.value = "";
          this.userInput.focus();
          this.renderConversationsList();
        }
      },
      getSystemPrompt(lang) {
        return {
          en: "You are a helpful assistant.",
          es: "Eres un asistente útil.",
          zh: "你是一个有帮助的助手。",
          hi: "आप एक सहायक सहायक हैं।",
          ar: "أنت مساعد مفيد.",
          fr: "Vous êtes un assistant utile.",
          ru: "Вы полезный помощник.",
          pt: "Você é um assistente útil."
        }[lang] || "Você é um assistente útil.";
      },
      createNewConversation() {
        const id = "conv_" + Date.now();
        this.conversations[id] = [];
        this.currentConversationId = id;
        this.saveConversations();
        this.renderConversationsList();
        this.renderCurrentConversation();
        this.userInput.focus();
      },
      saveConversations() {
        localStorage.setItem("vibot_conversations", JSON.stringify(this.conversations));
        localStorage.setItem("vibot_current", this.currentConversationId);
      },
      loadConversations() {
        const data = localStorage.getItem("vibot_conversations");
        if (data) {
          this.conversations = JSON.parse(data);
          this.currentConversationId = localStorage.getItem("vibot_current") || Object.keys(this.conversations)[0];
        } else {
          this.conversations = {};
        }
      },
      renderConversationsList() {
        this.conversationList.innerHTML = "";
        Object.keys(this.conversations).reverse().forEach(id => {
          const btn = document.createElement('button');
          btn.className = "conversation-btn" + (id === this.currentConversationId ? " active" : "");
          const first = this.conversations[id].find(m => m.role === "user");
          btn.textContent = first ? (first.content.length > 20 ? first.content.slice(0, 20) + "…" : first.content) : "Nova Conversa";
          btn.onclick = () => {
            this.currentConversationId = id;
            this.saveConversations();
            this.renderConversationsList();
            this.renderCurrentConversation();
          };
          this.conversationList.appendChild(btn);
        });
      },
      renderCurrentConversation() {
        this.chatbox.innerHTML = "";
        (this.conversations[this.currentConversationId] || []).forEach(m => this.addMessage(m.content, m.role));
      },
      addMessage(text, role) {
        const d = document.createElement('div');
        d.className = "message " + (["user", "bot", "error"].includes(role) ? role : "bot");
        d.textContent = text;
        this.chatbox.appendChild(d);
        this.chatbox.scrollTop = this.chatbox.scrollHeight;
      },
      conversations: {}, currentConversationId: null
    };

    window.addEventListener('DOMContentLoaded', () => ViBot.init());
  </script>
</body>
</html>
