<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ViBot - Assistente Virtual</title>
  <style>
    :root {
      --primary: #4f46e5;
      --user-bg: #4f46e5;
      --bot-bg: #f3f4f6;
      --error-bg: #fee2e2;
      --text: #111827;
      --error-text: #dc2626;
      --bg: #f9fafb;
    }
    [data-theme="dark"] {
      --bg: #1f2937;
      --bot-bg: #374151;
      --text: #f9fafb;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0; padding: 0;
      transition: background 0.3s, color 0.3s;
    }
    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 32px; background: white; border-bottom: 1px solid #e5e7eb;
    }
    [data-theme="dark"] header { background: #111827; }
    h1 { margin: 0; color: var(--primary); }
    header div { display: flex; align-items: center; gap: 8px; }
    button, select {
      font-size: 14px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: white;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    main { display: flex; max-width: 1100px; margin: 20px auto; gap: 20px; padding: 0 20px; }
    #chat-container { flex: 1; display: flex; flex-direction: column; }
    #chatbox {
      background: white; border: 1px solid #e5e7eb; border-radius: 12px;
      flex: 1; padding: 16px; overflow-y: auto;
      display: flex; flex-direction: column; gap: 12px;
    }
    .message {
      padding: 12px 16px; border-radius: 12px; max-width: 85%;
      line-height: 1.5; animation: fadeIn 0.3s ease-out;
      word-wrap: break-word; white-space: pre-wrap;
    }
    .user { background: var(--user-bg); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .bot { background: var(--bot-bg); color: var(--text); align-self: flex-start; border-bottom-left-radius: 4px; }
    .error { background: var(--error-bg); color: var(--error-text); align-self: center; text-align: center; }
    .typing { color: #6b7280; font-style: italic; animation: blink 1s steps(1) infinite; }
    @keyframes fadeIn { from {opacity:0;transform:translateY(10px);} to {opacity:1;transform:translateY(0);} }
    @keyframes blink { 50% {opacity:0.5;} }
    #input-container { display: flex; gap: 12px; margin-top: 12px; }
    #userInput {
      flex: 1; padding: 12px 16px; border: 1px solid #e5e7eb;
      border-radius: 12px; font-size: 16px;
    }
    #sendBtn {
      background: var(--primary); color: white; border: none;
      border-radius: 12px; padding: 0 24px; font-weight: 500;
      cursor: pointer; transition: background-color 0.2s;
    }
    #sendBtn:hover:not(:disabled) { background: #4338ca; }
    #sendBtn:disabled { background: #9ca3af; cursor: not-allowed; }
    aside {
      width: 250px; background: white; border: 1px solid #e5e7eb;
      border-radius: 12px; padding: 16px; display: flex;
      flex-direction: column; gap: 12px;
    }
    #newConversationBtn {
      background: var(--primary); color: white; border: none;
      border-radius: 12px; padding: 12px; font-weight: 600;
      cursor: pointer; transition: background-color 0.2s;
    }
    #newConversationBtn:hover { background: #4338ca; }
    #conversationList {
      overflow-y: auto; flex: 1;
      display: flex; flex-direction: column; gap: 8px;
    }
    .conversation-btn {
      background: #f3f4f6; border: none; border-radius: 8px;
      padding: 8px 12px; font-size: 14px; color: var(--text);
      text-align: left; white-space: nowrap; overflow: hidden;
      text-overflow: ellipsis; cursor: pointer;
      transition: background-color 0.2s;
    }
    .conversation-btn:hover { background: var(--primary); color: white; }
    .conversation-btn.active { background: var(--primary); color: white; font-weight: 700; }
    @media(max-width:768px) {
      main { flex-direction: column; }
      aside { width:100%; margin-bottom:20px; order:-1; }
      #chatbox { height:50vh; }
      #input-container { flex-direction:column; }
      #sendBtn { width:100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ViBot</h1>
    <div>
      <button id="toggleTheme">üåì Tema</button>
      <button id="startSpeech">üéôÔ∏è Voz</button>
      <button id="exportHistory">üìÇ Exportar</button>
      <select id="languageSelector">
        <option value="pt" selected>Portugu√™s</option>
        <option value="en">English</option>
        <option value="es">Espa√±ol</option>
        <option value="zh">‰∏≠Êñá</option>
        <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        <option value="fr">Fran√ßais</option>
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      </select>
    </div>
  </header>

  <main>
    <div id="chat-container">
      <div id="chatbox" role="log" aria-live="polite"></div>
      <div id="input-container">
        <input id="userInput" placeholder="Digite sua mensagem..." />
        <button id="sendBtn">üì© Enviar</button>
      </div>
    </div>
    <aside>
      <button id="newConversationBtn">‚ûï Nova Conversa</button>
      <div id="conversationList"></div>
    </aside>
  </main>

  <script>
    const ViBot = {
      config: {
        apiUrl: "https://api.groq.com/openai/v1/chat/completions",
        apiKey: "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",
        model: "llama3-70b-8192",
        temperature: 0.7,
        maxTokens: 1024
      },
      init() {
        ["chatbox","userInput","sendBtn","newConversationBtn","conversationList","languageSelector","toggleTheme","startSpeech","exportHistory"]
          .forEach(id => this[id] = document.getElementById(id));
        this.typingIndicator = Object.assign(document.createElement("div"), {
          className: "message bot typing",
          textContent: "ViBot est√° digitando..."
        });
        this.loadTheme();
        this.loadConversations();
        if (!this.currentConversationId) this.createNewConversation();
        else this.renderConversationsList(), this.renderCurrentConversation();

        this.sendBtn.onclick = () => this.sendMessage();
        this.userInput.onkeydown = e => { if (e.key === "Enter") { e.preventDefault(); this.sendMessage(); }};
        this.newConversationBtn.onclick = () => this.createNewConversation();
        this.toggleTheme.onclick = () => this.toggleTheme();
        this.exportHistory.onclick = () => this.exportCurrent();
        this.startSpeech.onclick = () => this.toggleVoice();
      },
      loadTheme() {
        const t = localStorage.getItem('vibot_theme') || 'light';
        document.documentElement.setAttribute('data-theme', t);
      },
      toggleTheme() {
        const cur = document.documentElement.getAttribute('data-theme');
        const nxt = cur === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', nxt);
        localStorage.setItem('vibot_theme', nxt);
      },
      toggleVoice() {
        if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
          return alert('Reconhecimento de voz n√£o suportado.');
        }
        if (this.recognizer) {
          this.recognizer.stop();
          this.recognizer = null;
          this.startSpeech.textContent = 'üéôÔ∏è Voz';
        } else {
          const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
          this.recognizer = new SR();
          this.recognizer.lang = this.languageSelector.value;
          this.recognizer.interimResults = false;
          this.recognizer.start();
          this.startSpeech.textContent = 'üõë Parar';
          this.recognizer.onresult = e => {
            this.userInput.value = e.results[0][0].transcript;
            this.sendMessage();
          };
          this.recognizer.onerror = () => {
            this.recognizer.stop();
            this.recognizer = null;
            this.startSpeech.textContent = 'üéôÔ∏è Voz';
          };
        }
      },
      speak(text) {
        if ('speechSynthesis' in window) {
          const ut = new SpeechSynthesisUtterance(text);
          ut.lang = this.languageSelector.value;
          speechSynthesis.speak(ut);
        }
      },
      exportCurrent() {
        const conv = this.conversations[this.currentConversationId] || [];
        const txt = conv.map(m => (m.role === 'user' ? 'Voc√™: ' : 'ViBot: ') + m.content).join('\n');
        const blob = new Blob([txt], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'vibot_conversa.txt';
        a.click();
        URL.revokeObjectURL(a.href);
      },
      async sendMessage() {
        const prompt = this.userInput.value.trim();
        if (!prompt) return;
        this.sendBtn.disabled = true;
        this.addMessage(prompt, "user");
        this.conversations[this.currentConversationId].push({ role: "user", content: prompt });
        this.saveConversations();
        this.chatbox.appendChild(this.typingIndicator);
        this.chatbox.scrollTop = this.chatbox.scrollHeight;

        try {
          const sys = this.getSystemPrompt(this.languageSelector.value);
          const body = {
            model: this.config.model,
            messages: [{ role: "system", content: sys }, ...this.conversations[this.currentConversationId]],
            temperature: this.config.temperature,
            max_tokens: this.config.maxTokens
          };

          const res = await fetch(this.config.apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${this.config.apiKey}`
            },
            body: JSON.stringify(body)
          });

          const contentType = res.headers.get("content-type");
          let data;

          if (contentType && contentType.includes("application/json")) {
            data = await res.json();
          } else {
            const text = await res.text();
            console.error("Resposta n√£o JSON:", text);
            throw new Error(`A resposta da API n√£o √© JSON. Conte√∫do recebido: ${text.slice(0, 200)}`);
          }

          if (!res.ok) {
            console.error("Erro da API:", data);
            throw new Error(`Erro ${res.status}: ${data.error?.message || JSON.stringify(data)}`);
          }

          const bot = data.choices?.[0]?.message?.content?.trim();
          if (!bot) throw new Error("Resposta vazia");

          this.chatbox.removeChild(this.typingIndicator);
          this.addMessage(bot, "bot");
          this.conversations[this.currentConversationId].push({ role: "bot", content: bot });
          this.speak(bot);
          this.saveConversations();
        } catch (e) {
          this.chatbox.removeChild(this.typingIndicator);
          this.addMessage("Erro: " + e.message, "error");
          this.conversations[this.currentConversationId].push({ role: "error", content: e.message });
          this.saveConversations();
          console.error(e);
        } finally {
          this.sendBtn.disabled = false;
          this.userInput.value = "";
          this.userInput.focus();
          this.renderConversationsList();
        }
      },
      getSystemPrompt(lang) {
        return {
          en: "You are a helpful assistant.",
          es: "Eres un asistente √∫til.",
          zh: "‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÂ∏ÆÂä©ÁöÑÂä©Êâã„ÄÇ",
          hi: "‡§Ü‡§™ ‡§è‡§ï ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§π‡•à‡§Ç‡•§",
          ar: "ÿ£ŸÜÿ™ ŸÖÿ≥ÿßÿπÿØ ŸÖŸÅŸäÿØ.",
          fr: "Vous √™tes un assistant utile.",
          ru: "–í—ã –ø–æ–ª–µ–∑–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫.",
          pt: "Voc√™ √© um assistente √∫til."
        }[lang] || "Voc√™ √© um assistente √∫til.";
      },
      createNewConversation() {
        const id = "conv_" + Date.now();
        this.conversations[id] = [];
        this.currentConversationId = id;
        this.saveConversations();
        this.renderConversationsList();
        this.renderCurrentConversation();
        this.userInput.focus();
      },
      saveConversations() {
        localStorage.setItem("vibot_conversations", JSON.stringify(this.conversations));
        localStorage.setItem("vibot_current", this.currentConversationId);
      },
      loadConversations() {
        const data = localStorage.getItem("vibot_conversations");
        if (data) {
          this.conversations = JSON.parse(data);
          this.currentConversationId = localStorage.getItem("vibot_current") || Object.keys(this.conversations)[0];
        }
      },
      renderConversationsList() {
        this.conversationList.innerHTML = "";
        Object.keys(this.conversations).reverse().forEach(id => {
          const btn = document.createElement('button');
          btn.className = "conversation-btn" + (id === this.currentConversationId ? " active" : "");
          const first = this.conversations[id].find(m => m.role === "user");
          btn.textContent = first ? (first.content.length > 20 ? first.content.slice(0,20)+"‚Ä¶" : first.content) : "Nova Conversa";
          btn.onclick = () => {
            this.currentConversationId = id;
            this.saveConversations();
            this.renderConversationsList();
            this.renderCurrentConversation();
          };
          this.conversationList.appendChild(btn);
        });
      },
      renderCurrentConversation() {
        this.chatbox.innerHTML = "";
        (this.conversations[this.currentConversationId] || []).forEach(m => this.addMessage(m.content, m.role));
      },
      addMessage(text, role) {
        const d = document.createElement('div');
        d.className = "message " + (["user","bot","error"].includes(role) ? role : "bot");
        d.textContent = text;
        this.chatbox.appendChild(d);
        this.chatbox.scrollTop = this.chatbox.scrollHeight;
      },
      conversations: {}, currentConversationId: null
    };

    window.addEventListener('DOMContentLoaded', () => ViBot.init());
  </script>
</body>
</html>
