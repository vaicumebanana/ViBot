<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ViBot - Assistente Virtual</title>
  <style>
    :root {
      --primary: #4f46e5;
      --user-bg: #4f46e5;
      --bot-bg: #f3f4f6;
      --error-bg: #fee2e2;
      --text: #111827;
      --error-text: #dc2626;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
      margin: 0;
      padding: 0;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 32px;
      background-color: white;
      border-bottom: 1px solid #e5e7eb;
    }

    h1 {
      margin: 0;
      color: var(--primary);
    }

    #languageSelector {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    main {
      max-width: 900px;
      margin: 20px auto;
      display: flex;
      gap: 20px;
      padding: 0 20px;
    }

    /* Chat container */
    #chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #chatbox {
      height: 65vh;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }

    .message {
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 85%;
      line-height: 1.5;
      animation: fadeIn 0.3s ease-out;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message.user {
      background: var(--user-bg);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message.bot {
      background: var(--bot-bg);
      color: var(--text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .message.error {
      background: var(--error-bg);
      color: var(--error-text);
      align-self: center;
      text-align: center;
    }

    .message.typing {
      color: #6b7280;
      font-style: italic;
      animation: blink 1s steps(1) infinite;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes blink {
      50% { opacity: 0.5; }
    }

    #input-container {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    #userInput {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
    }

    #sendBtn {
      padding: 0 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    #sendBtn:hover:not(:disabled) {
      background: #4338ca;
    }

    #sendBtn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    /* Sidebar for conversations */
    aside {
      width: 250px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: 65vh;
    }

    #newConversationBtn {
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    #newConversationBtn:hover {
      background: #4338ca;
    }

    #conversationList {
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .conversation-btn {
      background: #f3f4f6;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      text-align: left;
      font-size: 14px;
      color: var(--text);
      transition: background-color 0.2s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-btn:hover {
      background: var(--primary);
      color: white;
    }

    .conversation-btn.active {
      background: var(--primary);
      color: white;
      font-weight: 700;
    }

  </style>
</head>
<body>
  <header>
    <h1>ViBot</h1>
    <select id="languageSelector" title="Selecione o idioma">
      <option value="pt" selected>Português</option>
      <option value="en">English</option>
      <option value="es">Español</option>
      <option value="zh">中文 (Chinês)</option>
      <option value="hi">हिन्दी (Hindi)</option>
      <option value="ar">العربية (Árabe)</option>
      <option value="fr">Français (Francês)</option>
      <option value="ru">Русский (Russo)</option>
    </select>
  </header>

  <main>
    <div id="chat-container">
      <div id="chatbox" role="log" aria-live="polite" aria-relevant="additions"></div>
      <div id="input-container">
        <input type="text" id="userInput" placeholder="Digite sua mensagem..." autocomplete="off" aria-label="Digite sua mensagem"/>
        <button id="sendBtn" aria-label="Enviar mensagem">Enviar</button>
      </div>
    </div>

    <aside aria-label="Lista de conversas anteriores e nova conversa">
      <button id="newConversationBtn" aria-label="Nova conversa">+ Nova Conversa</button>
      <div id="conversationList" role="list" aria-label="Conversas anteriores">
        <!-- Conversas aparecerão aqui -->
      </div>
    </aside>
  </main>

  <script>
    const ViBot = {
      config: {
        apiUrl: "https://api.groq.com/openai/v1/chat/completions",
        apiKey: "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",
        model: "llama3-70b-8192",
        temperature: 0.7,
        maxTokens: 1024
      },

      language: 'pt',
      conversations: {},
      currentConversationId: null,

      init() {
        this.DOM = {
          chatbox: document.getElementById('chatbox'),
          input: document.getElementById('userInput'),
          sendBtn: document.getElementById('sendBtn'),
          langSelector: document.getElementById('languageSelector'),
          conversationList: document.getElementById('conversationList'),
          newConvBtn: document.getElementById('newConversationBtn'),
          typingIndicator: this.createTypingIndicator()
        };

        this.loadConversations();

        if (!this.currentConversationId) {
          this.createNewConversation();
        } else {
          this.renderConversation();
        }

        this.setupEvents();
        this.renderConversationsList();

        // Set placeholder language on init
        this.DOM.input.placeholder = this.getPlaceholder(this.language);
      },

      setupEvents() {
        this.DOM.sendBtn.addEventListener('click', () => this.sendMessage());
        this.DOM.input.addEventListener('keypress', e => {
          if (e.key === 'Enter') this.sendMessage();
        });
        this.DOM.langSelector.addEventListener('change', e => {
          this.language = e.target.value;
          this.DOM.input.placeholder = this.getPlaceholder(this.language);
        });

        this.DOM.newConvBtn.addEventListener('click', () => {
          this.createNewConversation();
          this.renderConversationsList();
        });
      },

      getPlaceholder(lang) {
        return {
          pt: "Digite sua mensagem...",
          en: "Type your message...",
          es: "Escribe tu mensaje...",
          zh: "输入你的信息...",
          hi: "अपना संदेश टाइप करें...",
          ar: "اكتب رسالتك...",
          fr: "Tapez votre message...",
          ru: "Введите ваше сообщение..."
        }[lang] || "Digite sua mensagem...";
      },

      createNewConversation() {
        const id = `conv_${Date.now()}`;
        this.conversations[id] = [];
        this.currentConversationId = id;
        this.renderConversation();
        this.saveConversations();
        this.renderConversationsList();
      },

      renderConversation() {
        this.DOM.chatbox.innerHTML = '';
        const msgs = this.conversations[this.currentConversationId] || [];
        msgs.forEach(m => this.addMessage(m.content, m.role === 'user' ? 'user' : (m.role === 'assistant' ? 'bot' : 'error'), false));
        this.DOM.chatbox.scrollTop = this.DOM.chatbox.scrollHeight;
      },

      renderConversationsList() {
        if (!this.DOM.conversationList) return;

        this.DOM.conversationList.innerHTML = '';
        Object.entries(this.conversations).forEach(([id, messages]) => {
          const btn = document.createElement('button');
          btn.className = 'conversation-btn';
          btn.textContent = messages.length > 0 ? messages[0].content.slice(0, 20) : 'Nova conversa';
          if (id === this.currentConversationId) btn.classList.add('active');

          btn.onclick = () => {
            this.currentConversationId = id;
            this.renderConversation();
            this.renderConversationsList();
          };

          this.DOM.conversationList.appendChild(btn);
        });
      },

      async sendMessage() {
        const message = this.DOM.input.value.trim();
        if (!message) return;

        this.addMessage(message, 'user');
        this.conversations[this.currentConversationId].push({ role: 'user', content: message });
        this.DOM.input.value = '';
        this.DOM.sendBtn.disabled = true;

        this.DOM.chatbox.appendChild(this.DOM.typingIndicator);
        this.DOM.chatbox.scrollTop = this.DOM.chatbox.scrollHeight;

        try {
          const messagesForAPI = this.buildMessagesForAPI();

          const responseText = await this.callAPI(messagesForAPI);
          this.DOM.chatbox.removeChild(this.DOM.typingIndicator);

          this.addMessage(responseText, 'bot');
          this.conversations[this.currentConversationId].push({ role: 'assistant', content: responseText });

          this.saveConversations();
        } catch (error) {
          this.DOM.chatbox.removeChild(this.DOM.typingIndicator);
          this.addMessage(`Erro: ${error.message}`, 'error');
          this.conversations[this.currentConversationId].push({ role: 'error', content: `Erro: ${error.message}` });
          this.saveConversations();
          console.error("ViBot Error:", error);
        } finally {
          this.DOM.sendBtn.disabled = false;
          this.DOM.input.focus();
          this.renderConversationsList();
        }
      },

      buildMessagesForAPI() {
        const systemMsg = this.language !== 'pt'
          ? { role: 'system', content: `Responda em ${this.getLanguageName(this.language)}.` }
          : { role: 'system', content: `Você é um assistente virtual que responde em português.` };

        const history = this.conversations[this.currentConversationId] || [];
        // Send only user and assistant messages to keep context clean
        const filtered = history.filter(m => m.role === 'user' || m.role === 'assistant');

        return [systemMsg, ...filtered];
      },

      async callAPI(messages) {
        const response = await fetch(this.config.apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.config.apiKey}`
          },
          body: JSON.stringify({
            model: this.config.model,
            messages: messages,
            temperature: this.config.temperature,
            max_tokens: this.config.maxTokens
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error?.message || 'Erro na API');
        }

        const data = await response.json();

        if (data.choices && data.choices.length > 0 && data.choices[0].message) {
          return data.choices[0].message.content.trim();
        } else {
          throw new Error('Resposta inesperada da API');
        }
      },

      addMessage(text, type, scroll = true) {
        const msg = document.createElement('div');
        msg.className = `message ${type}`;
        msg.textContent = text;
        this.DOM.chatbox.appendChild(msg);
        if (scroll) this.DOM.chatbox.scrollTop = this.DOM.chatbox.scrollHeight;
      },

      createTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'message bot typing';
        indicator.textContent = 'Digitando...';
        return indicator;
      },

      saveConversations() {
        try {
          localStorage.setItem('ViBotConversations', JSON.stringify(this.conversations));
        } catch (e) {
          console.warn("Não foi possível salvar as conversas:", e);
        }
      },

      loadConversations() {
        try {
          const stored = localStorage.getItem('ViBotConversations');
          if (stored) {
            this.conversations = JSON.parse(stored);
            const keys = Object.keys(this.conversations);
            if (keys.length > 0) {
              this.currentConversationId = keys[keys.length - 1];
            }
          }
        } catch (e) {
          console.warn("Erro ao carregar conversas:", e);
          this.conversations = {};
        }
      },

      getLanguageName(code) {
        return {
          pt: "Português",
          en: "Inglês",
          es: "Espanhol",
          zh: "Chinês",
          hi: "Hindi",
          ar: "Árabe",
          fr: "Francês",
          ru: "Russo"
        }[code] || "Português";
      }
    };

    document.addEventListener('DOMContentLoaded', () => ViBot.init());
  </script>
</body>
</html>
