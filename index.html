<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ViBot</title>
<style>
  :root {
    --primary: #4f46e5;
    --user-bg: #4f46e5;
    --bot-bg: #f3f4f6;
    --error-bg: #fee2e2;
    --text: #111827;
    --error-text: #dc2626;
    --bg: #f9fafb;
    --copy-bg: #e5e7eb;
  }
  [data-theme="dark"] {
    --primary: #6366f1;
    --bg: #1f2937;
    --bot-bg: #374151;
    --text: #f9fafb;
    --user-bg: #6366f1;
    --copy-bg: #4b5563;
  }
  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0; padding: 0;
    transition: background 0.3s, color 0.3s;
  }
  header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 32px; background: white; border-bottom: 1px solid #e5e7eb;
  }
  [data-theme="dark"] header { background: #111827; border-color: #374151; }
  h1 { margin: 0; color: var(--primary); }
  header div { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  button, select {
    font-size: 14px;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    background: white;
    cursor: pointer;
  }
  [data-theme="dark"] button, [data-theme="dark"] select {
    background: #1f2937;
    color: white;
    border-color: #4b5563;
  }
  button:hover { opacity: 0.9; }
  main { display: flex; max-width: 1100px; margin: 20px auto; gap: 20px; padding: 0 20px; }
  #chat-container { flex: 1; display: flex; flex-direction: column; }
  #chatbox {
    background: white; border: 1px solid #e5e7eb; border-radius: 12px;
    flex: 1; padding: 16px; overflow-y: auto;
    display: flex; flex-direction: column; gap: 12px;
    min-height: 400px;
  }
  [data-theme="dark"] #chatbox {
    background: #111827;
    border-color: #374151;
  }
  .message {
    padding: 12px 16px; border-radius: 12px; max-width: 85%;
    line-height: 1.5; animation: fadeIn 0.3s ease-out;
    word-wrap: break-word; white-space: pre-wrap;
    position: relative;
  }
  .user { background: var(--user-bg); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
  .bot { background: var(--bot-bg); color: var(--text); align-self: flex-start; border-bottom-left-radius: 4px; }
  .error { background: var(--error-bg); color: var(--error-text); align-self: center; text-align: center; }
  .typing { color: #6b7280; font-style: italic; animation: blink 1s steps(1) infinite; }
  @keyframes fadeIn { from {opacity:0;transform:translateY(10px);} to {opacity:1;transform:translateY(0);} }
  @keyframes blink { 50% {opacity:0.5;} }
  #input-container { display: flex; gap: 12px; margin-top: 12px; }
  #userInput {
    flex: 1; padding: 12px 16px; border: 1px solid #e5e7eb;
    border-radius: 12px; font-size: 16px; background: white;
  }
  [data-theme="dark"] #userInput {
    background: #1f2937;
    color: white;
    border-color: #4b5563;
  }
  #sendBtn {
    background: var(--primary); color: white; border: none;
    border-radius: 12px; padding: 0 24px; font-weight: 500;
    cursor: pointer; transition: background-color 0.2s;
  }
  #sendBtn:hover { background: #4338ca; }
  #sendBtn:disabled { background: #9ca3af; cursor: not-allowed; }
  aside {
    width: 250px; background: white; border: 1px solid #e5e7eb;
    border-radius: 12px; padding: 16px; display: flex;
    flex-direction: column; gap: 12px;
  }
  [data-theme="dark"] aside {
    background: #111827;
    border-color: #374151;
  }
  #newConversationBtn {
    background: var(--primary); color: white; border: none;
    border-radius: 12px; padding: 12px; font-weight: 600;
    cursor: pointer; transition: background-color 0.2s;
  }
  #newConversationBtn:hover { background: #4338ca; }
  #conversationList {
    overflow-y: auto; flex: 1;
    display: flex; flex-direction: column; gap: 8px;
  }
  .conversation-btn {
    background: #f3f4f6; border: none; border-radius: 8px;
    padding: 8px 12px; font-size: 14px; color: var(--text);
    text-align: left; white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis; cursor: pointer;
    transition: background-color 0.2s;
    position: relative;
  }
  [data-theme="dark"] .conversation-btn {
    background: #374151;
  }
  .conversation-btn:hover { background: var(--primary); color: white; }
  .conversation-btn.active { background: var(--primary); color: white; font-weight: 700; }
  .conversation-actions {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 4px;
  }
  .conversation-btn:hover .conversation-actions {
    display: flex;
  }
  .message-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 8px;
    gap: 8px;
  }
  .action-btn {
    background: var(--copy-bg);
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .user .action-btn {
    background: rgba(255, 255, 255, 0.2);
  }
  [data-theme="dark"] .action-btn {
    background: rgba(255, 255, 255, 0.1);
  }
  [data-theme="dark"] .user .action-btn {
    background: rgba(0, 0, 0, 0.2);
  }
  .action-btn:hover {
    background: rgba(0, 0, 0, 0.2);
  }
  .user .action-btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }
  .model-selector {
    margin-top: 12px;
    width: 100%;
  }
  .settings-panel {
    margin-top: 12px;
    padding: 12px;
    background: var(--bot-bg);
    border-radius: 8px;
  }
  .settings-title {
    font-weight: bold;
    margin-bottom: 8px;
  }
  .slider-container {
    margin: 12px 0;
  }
  .slider-label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }
  .slider-value {
    font-weight: bold;
  }
  input[type="range"] {
    width: 100%;
  }
  .token-count {
    font-size: 12px;
    color: #6b7280;
    text-align: right;
    margin-top: 4px;
  }
  [data-theme="dark"] .token-count {
    color: #9ca3af;
  }
  .system-prompt-container {
    margin-top: 12px;
  }
  #systemPrompt {
    width: 100%;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    background: white;
    font-family: inherit;
    resize: vertical;
    min-height: 60px;
  }
  [data-theme="dark"] #systemPrompt {
    background: #1f2937;
    color: white;
    border-color: #4b5563;
  }
  @media(max-width:768px) {
    main { flex-direction: column; }
    aside { width:100%; margin-bottom:20px; order:-1; }
    #chatbox { height:50vh; }
    #input-container { flex-direction:column; }
    #sendBtn { width:100%; }
    .conversation-actions {
      display: flex;
    }
    header div {
      gap: 4px;
    }
    button, select {
      padding: 6px;
      font-size: 12px;
    }
  }
</style>
</head>
<body>
<header>
  <h1>ViBot</h1>
  <div>
    <button id="toggleTheme" aria-label="Alternar tema">üåì Tema</button>
    <button id="startSpeech" aria-label="Ativar/desativar voz">üéôÔ∏è Voz</button>
    <button id="exportHistory" aria-label="Exportar hist√≥rico">üìÇ Exportar</button>
    <button id="importHistory" aria-label="Importar hist√≥rico">üìÅ Importar</button>
    <button id="settingsBtn" aria-label="Configura√ß√µes">‚öôÔ∏è Config</button>
    <select id="languageSelector" aria-label="Selecionar idioma">
      <option value="pt-BR" selected>Portugu√™s</option>
      <option value="en-US">English</option>
      <option value="es">Espa√±ol</option>
      <option value="zh">‰∏≠Êñá</option>
      <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
      <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
      <option value="fr">Fran√ßais</option>
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
    </select>
  </div>
</header>

<main>
  <div id="chat-container">
    <div id="chatbox" role="log" aria-live="polite" aria-atomic="false"></div>
    <div id="input-container">
      <input id="userInput" placeholder="Digite sua mensagem..." autocomplete="off" />
      <button id="sendBtn" aria-label="Enviar mensagem">üì© Enviar</button>
    </div>
  </div>
  <aside>
    <button id="newConversationBtn" aria-label="Nova conversa">‚ûï Nova Conversa</button>
    <div id="conversationList" aria-label="Lista de conversas"></div>
    
    <div class="settings-panel" id="settingsPanel" style="display: none;">
      <div class="settings-title">Configura√ß√µes do Modelo</div>
      
      <select id="modelSelector" class="model-selector">
        <option value="llama3-70b-8192">ViBot Pro (Alta Performance)</option>
        <option value="llama3-8b-8192">ViBot Standard (Balan√ßo)</option>
        <option value="mixtral-8x7b-32768">ViBot Expert (Conhecimento Avan√ßado)</option>
        <option value="gemma-7b-it">ViBot Lite (R√°pido e Leve)</option>
      </select>
      
      <div class="slider-container">
        <div class="slider-label">
          <span>Criatividade</span>
          <span class="slider-value" id="temperatureValue">0.7</span>
        </div>
        <input type="range" id="temperatureSlider" min="0" max="2" step="0.1" value="0.7" />
      </div>
      
      <div class="slider-container">
        <div class="slider-label">
          <span>Tamanho da Resposta</span>
          <span class="slider-value" id="maxTokensValue">1024</span>
        </div>
        <input type="range" id="maxTokensSlider" min="256" max="4096" step="128" value="1024" />
        <div class="token-count" id="tokenCount">Tokens usados: 0</div>
      </div>
      
      <div class="system-prompt-container">
        <div class="settings-title">Instru√ß√µes do Sistema</div>
        <textarea id="systemPrompt" placeholder="Como o assistente deve se comportar..."></textarea>
      </div>
    </div>
  </aside>
</main>

<input type="file" id="importFile" accept=".json,.txt" style="display: none;" aria-hidden="true" />

<script>
  const ViBot = {
    config: {
      apiUrl: "https://api.groq.com/openai/v1/chat/completions",
      apiKey: "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",
      model: "llama3-70b-8192",
      temperature: 0.7,
      maxTokens: 1024,
      systemPrompt: "Voc√™ √© um assistente √∫til chamado ViBot. Responda de forma clara e concisa no idioma do usu√°rio."
    },

    // Mapeamento dos modelos para nomes amig√°veis
    modelNames: {
      "llama3-70b-8192": "ViBot Pro (Alta Performance)",
      "llama3-8b-8192": "ViBot Standard (Balan√ßo)",
      "mixtral-8x7b-32768": "ViBot Expert (Conhecimento Avan√ßado)",
      "gemma-7b-it": "ViBot Lite (R√°pido e Leve)"
    },

    // Mapeamento reverso para obter o ID do modelo a partir do nome
    getModelIdByName(name) {
      for (const [id, modelName] of Object.entries(this.modelNames)) {
        if (modelName === name) return id;
      }
      return "llama3-70b-8192"; // padr√£o
    },

    init() {
      // Elementos
      this.chatbox = document.getElementById("chatbox");
      this.userInput = document.getElementById("userInput");
      this.sendBtn = document.getElementById("sendBtn");
      this.newConversationBtn = document.getElementById("newConversationBtn");
      this.conversationList = document.getElementById("conversationList");
      this.languageSelector = document.getElementById("languageSelector");
      this.toggleThemeBtn = document.getElementById("toggleTheme");
      this.startSpeechBtn = document.getElementById("startSpeech");
      this.exportHistoryBtn = document.getElementById("exportHistory");
      this.importHistoryBtn = document.getElementById("importHistory");
      this.importFileInput = document.getElementById("importFile");
      this.settingsBtn = document.getElementById("settingsBtn");
      this.settingsPanel = document.getElementById("settingsPanel");
      this.modelSelector = document.getElementById("modelSelector");
      this.temperatureSlider = document.getElementById("temperatureSlider");
      this.temperatureValue = document.getElementById("temperatureValue");
      this.maxTokensSlider = document.getElementById("maxTokensSlider");
      this.maxTokensValue = document.getElementById("maxTokensValue");
      this.tokenCount = document.getElementById("tokenCount");
      this.systemPrompt = document.getElementById("systemPrompt");

      this.speaking = false;
      this.speechSynthesis = window.speechSynthesis;
      this.currentUtterance = null;
      this.totalTokens = 0;

      this.typingIndicator = document.createElement("div");
      this.typingIndicator.className = "message bot typing";
      this.typingIndicator.textContent = "ViBot est√° digitando...";

      this.loadTheme();
      this.loadSettings();
      this.loadConversations();

      if (!this.currentConversationId || !this.conversations[this.currentConversationId]) {
        this.createNewConversation();
      } else {
        this.renderConversationsList();
        this.renderCurrentConversation();
      }

      // Eventos
      this.sendBtn.onclick = () => this.sendMessage();
      this.userInput.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          this.sendMessage();
        }
      });
      this.newConversationBtn.onclick = () => this.createNewConversation();
      this.toggleThemeBtn.onclick = () => this.toggleTheme();
      this.startSpeechBtn.onclick = () => this.toggleSpeech();
      this.exportHistoryBtn.onclick = () => this.exportHistory();
      this.importHistoryBtn.onclick = () => this.importFileInput.click();
      this.importFileInput.onchange = e => this.importHistory(e);
      this.languageSelector.onchange = e => this.changeLanguage(e.target.value);
      this.settingsBtn.onclick = () => this.toggleSettings();
      this.modelSelector.onchange = e => this.updateModel(this.getModelIdByName(e.target.value));
      this.temperatureSlider.oninput = e => this.updateTemperature(e.target.value);
      this.maxTokensSlider.oninput = e => this.updateMaxTokens(e.target.value);
      this.systemPrompt.onchange = () => this.saveSettings();

      this.userInput.focus();
    },

    conversations: {},
    currentConversationId: null,

    loadSettings() {
      const settings = localStorage.getItem("vibot_settings");
      if (settings) {
        try {
          const savedSettings = JSON.parse(settings);
          this.config.model = savedSettings.model || this.config.model;
          this.config.temperature = savedSettings.temperature || this.config.temperature;
          this.config.maxTokens = savedSettings.maxTokens || this.config.maxTokens;
          this.config.systemPrompt = savedSettings.systemPrompt || this.config.systemPrompt;
          
          // Atualiza UI
          this.modelSelector.value = this.modelNames[this.config.model] || this.modelNames["llama3-70b-8192"];
          this.temperatureSlider.value = this.config.temperature;
          this.temperatureValue.textContent = this.config.temperature;
          this.maxTokensSlider.value = this.config.maxTokens;
          this.maxTokensValue.textContent = this.config.maxTokens;
          this.systemPrompt.value = this.config.systemPrompt;
        } catch {
          // Usa valores padr√£o
        }
      }
    },

    saveSettings() {
      this.config.temperature = parseFloat(this.temperatureSlider.value);
      this.config.maxTokens = parseInt(this.maxTokensSlider.value);
      this.config.systemPrompt = this.systemPrompt.value;
      
      localStorage.setItem("vibot_settings", JSON.stringify({
        model: this.config.model,
        temperature: this.config.temperature,
        maxTokens: this.config.maxTokens,
        systemPrompt: this.config.systemPrompt
      }));
    },

    updateModel(modelId) {
      this.config.model = modelId;
      this.saveSettings();
    },

    updateTemperature(value) {
      this.config.temperature = parseFloat(value);
      this.temperatureValue.textContent = value;
      this.saveSettings();
    },

    updateMaxTokens(value) {
      this.config.maxTokens = parseInt(value);
      this.maxTokensValue.textContent = value;
      this.saveSettings();
    },

    updateTokenCount(tokens) {
      this.totalTokens += tokens;
      this.tokenCount.textContent = `Tokens usados: ${this.totalTokens}`;
    },

    toggleSettings() {
      this.settingsPanel.style.display = this.settingsPanel.style.display === "none" ? "block" : "none";
    },

    loadConversations() {
      const data = localStorage.getItem("vibot_conversations");
      if (data) {
        try {
          this.conversations = JSON.parse(data);
          this.currentConversationId = localStorage.getItem("vibot_currentConversationId");
        } catch {
          this.conversations = {};
          this.currentConversationId = null;
        }
      } else {
        this.conversations = {};
        this.currentConversationId = null;
      }
    },

    saveConversations() {
      localStorage.setItem("vibot_conversations", JSON.stringify(this.conversations));
      localStorage.setItem("vibot_currentConversationId", this.currentConversationId);
    },

    createNewConversation() {
      const id = "conv_" + Date.now();
      this.conversations[id] = [];
      this.currentConversationId = id;
      this.saveConversations();
      this.renderConversationsList();
      this.renderCurrentConversation();
      this.userInput.value = "";
      this.userInput.focus();
    },

    deleteConversation(id) {
      if (!confirm("Tem certeza que deseja excluir esta conversa?")) return;
      
      delete this.conversations[id];
      
      if (this.currentConversationId === id) {
        if (Object.keys(this.conversations).length > 0) {
          this.currentConversationId = Object.keys(this.conversations)[0];
        } else {
          this.createNewConversation();
          return;
        }
      }
      
      this.saveConversations();
      this.renderConversationsList();
      this.renderCurrentConversation();
    },

    renderConversationsList() {
      this.conversationList.innerHTML = "";
      Object.entries(this.conversations).forEach(([id, messages]) => {
        const btn = document.createElement("button");
        btn.className = "conversation-btn";
        
        const btnText = document.createElement("span");
        btnText.textContent = messages.length
          ? messages[messages.length - 1].content.slice(0, 30) + (messages[messages.length - 1].content.length > 30 ? "..." : "")
          : "(vazio)";
        
        btn.appendChild(btnText);
        
        // Adiciona a√ß√µes (bot√£o de excluir)
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "conversation-actions";
        
        const deleteBtn = document.createElement("button");
        deleteBtn.innerHTML = "üóëÔ∏è";
        deleteBtn.title = "Excluir conversa";
        deleteBtn.className = "action-btn";
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          this.deleteConversation(id);
        };
        
        actionsDiv.appendChild(deleteBtn);
        btn.appendChild(actionsDiv);
        
        if (id === this.currentConversationId) btn.classList.add("active");
        btn.onclick = () => {
          this.currentConversationId = id;
          this.saveConversations();
          this.renderConversationsList();
          this.renderCurrentConversation();
        };
        this.conversationList.appendChild(btn);
      });
    },

    renderCurrentConversation() {
      this.chatbox.innerHTML = "";
      if (!this.currentConversationId || !this.conversations[this.currentConversationId]) return;

      for (const msg of this.conversations[this.currentConversationId]) {
        this.addMessageToChatbox(msg.role === "user" ? "user" : "bot", msg.content);
      }
      this.scrollToBottom();
    },

    addMessageToChatbox(role, content) {
      const messageDiv = document.createElement("div");
      messageDiv.className = "message " + role;
      messageDiv.textContent = content;
      
      // Adiciona bot√µes de a√ß√£o
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "message-actions";
      
      // Bot√£o de TTS apenas para mensagens do bot
      if (role === "bot") {
        const ttsBtn = document.createElement("button");
        ttsBtn.className = "action-btn";
        ttsBtn.innerHTML = "üîä Ouvir";
        ttsBtn.onclick = () => this.speakText(content, this.languageSelector.value);
        actionsDiv.appendChild(ttsBtn);
      }
      
      // Bot√£o de copiar para todas as mensagens
      const copyBtn = document.createElement("button");
      copyBtn.className = "action-btn";
      copyBtn.innerHTML = "üìã Copiar";
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(content);
        copyBtn.innerHTML = "‚úì Copiado!";
        setTimeout(() => {
          copyBtn.innerHTML = "üìã Copiar";
        }, 2000);
      };
      actionsDiv.appendChild(copyBtn);
      
      messageDiv.appendChild(actionsDiv);
      this.chatbox.appendChild(messageDiv);
    },

    addMessage(role, content) {
      if (!this.currentConversationId) this.createNewConversation();
      this.conversations[this.currentConversationId].push({ role, content });
      this.saveConversations();
      this.addMessageToChatbox(role, content);
      this.scrollToBottom();
    },

    scrollToBottom() {
      this.chatbox.scrollTop = this.chatbox.scrollHeight;
    },

    async sendMessage() {
      const text = this.userInput.value.trim();
      if (!text) return;

      this.addMessage("user", text);
      this.userInput.value = "";
      this.sendBtn.disabled = true;

      this.chatbox.appendChild(this.typingIndicator);
      this.scrollToBottom();

      try {
        const lang = this.languageSelector.value;
        const response = await this.callChatAPI(text);
        
        this.chatbox.removeChild(this.typingIndicator);
        this.addMessage("bot", response);

        if (this.speaking) this.speakText(response, lang);

      } catch (error) {
        this.chatbox.removeChild(this.typingIndicator);
        this.addMessage("bot", "Erro: n√£o foi poss√≠vel obter resposta. Tente novamente.");
        console.error("Erro na API:", error);
      } finally {
        this.sendBtn.disabled = false;
      }
    },

    async callChatAPI(prompt) {
      // Prepara o hist√≥rico da conversa para enviar √† API
      const messages = [
        { role: "system", content: this.config.systemPrompt },
        ...this.conversations[this.currentConversationId].map(msg => ({
          role: msg.role,
          content: msg.content
        })),
        { role: "user", content: prompt }
      ];

      const body = {
        model: this.config.model,
        temperature: this.config.temperature,
        max_tokens: this.config.maxTokens,
        messages: messages
      };

      const res = await fetch(this.config.apiUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + this.config.apiKey
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        throw new Error("Erro na API: " + res.status);
      }
      
      const data = await res.json();
      
      if (data.usage && data.usage.total_tokens) {
        this.updateTokenCount(data.usage.total_tokens);
      }
      
      if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
        return data.choices[0].message.content.trim();
      }
      throw new Error("Resposta da API inesperada");
    },

    toggleTheme() {
      const current = document.documentElement.getAttribute("data-theme");
      if (current === "dark") {
        document.documentElement.removeAttribute("data-theme");
        localStorage.setItem("vibot_theme", "light");
      } else {
        document.documentElement.setAttribute("data-theme", "dark");
        localStorage.setItem("vibot_theme", "dark");
      }
    },

    loadTheme() {
      const saved = localStorage.getItem("vibot_theme");
      if (saved === "dark") {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    },

    toggleSpeech() {
      if (!("speechSynthesis" in window)) {
        alert("S√≠ntese de voz n√£o suportada neste navegador.");
        return;
      }
      this.speaking = !this.speaking;
      this.startSpeechBtn.textContent = this.speaking ? "üîà Voz: ON" : "üéôÔ∏è Voz";
      if (!this.speaking && this.speechSynthesis.speaking) {
        this.speechSynthesis.cancel();
      }
    },

    speakText(text, lang) {
      if (!("speechSynthesis" in window)) {
        alert("S√≠ntese de voz n√£o suportada neste navegador.");
        return;
      }
      
      if (this.speechSynthesis.speaking) {
        this.speechSynthesis.cancel();
      }

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang;
      this.speechSynthesis.speak(utterance);
    },

    exportHistory() {
      if (!this.currentConversationId || !this.conversations[this.currentConversationId]) return;
      const dataStr = JSON.stringify({
        conversation: this.conversations[this.currentConversationId],
        settings: {
          model: this.config.model,
          temperature: this.config.temperature,
          maxTokens: this.config.maxTokens,
          systemPrompt: this.config.systemPrompt
        }
      }, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `vibot_history_${this.currentConversationId}.json`;
      a.click();
      URL.revokeObjectURL(url);
    },

    importHistory(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const importedData = JSON.parse(e.target.result);
          
          // Verifica se √© o novo formato com settings ou o antigo apenas com conversa
          let importedConversation, importedSettings;
          if (importedData.conversation && Array.isArray(importedData.conversation)) {
            importedConversation = importedData.conversation;
            importedSettings = importedData.settings;
          } else if (Array.isArray(importedData)) {
            importedConversation = importedData;
          } else {
            throw new Error("Formato inv√°lido");
          }
          
          const id = "conv_" + Date.now();
          this.conversations[id] = importedConversation;
          this.currentConversationId = id;
          
          // Aplica configura√ß√µes se existirem no arquivo
          if (importedSettings) {
            this.config.model = importedSettings.model || this.config.model;
            this.config.temperature = importedSettings.temperature || this.config.temperature;
            this.config.maxTokens = importedSettings.maxTokens || this.config.maxTokens;
            this.config.systemPrompt = importedSettings.systemPrompt || this.config.systemPrompt;
            this.saveSettings();
            this.loadSettings(); // Atualiza a UI
          }
          
          this.saveConversations();
          this.renderConversationsList();
          this.renderCurrentConversation();
          this.userInput.focus();
          alert("Hist√≥rico importado com sucesso!");
        } catch {
          alert("Erro ao importar arquivo. Certifique-se de que √© um JSON v√°lido.");
        }
      };
      reader.readAsText(file);
      event.target.value = "";
    },

    changeLanguage(lang) {
      this.languageSelector.value = lang;
      this.userInput.focus();
    }
  };

  window.onload = () => ViBot.init();
</script>
</body>
</html>
