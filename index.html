<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ViBot Plus</title>
<style>
  :root {
    --primary: #4f46e5;
    --user-bg: #4f46e5;
    --bot-bg: #f3f4f6;
    --error-bg: #fee2e2;
    --text: #111827;
    --error-text: #dc2626;
    --bg: #f9fafb;
    --copy-bg: #e5e7eb;
    --toolbar-bg: #e5e7eb;
  }
  [data-theme="dark"] {
    --primary: #6366f1;
    --bg: #1f2937;
    --bot-bg: #374151;
    --text: #f9fafb;
    --user-bg: #6366f1;
    --copy-bg: #4b5563;
    --toolbar-bg: #374151;
  }
  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0; padding: 0;
    transition: background 0.3s, color 0.3s;
  }
  header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 32px; background: white; border-bottom: 1px solid #e5e7eb;
  }
  [data-theme="dark"] header { background: #111827; border-color: #374151; }
  h1 { margin: 0; color: var(--primary); }
  header div { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  button, select {
    font-size: 14px;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    background: white;
    cursor: pointer;
  }
  [data-theme="dark"] button, [data-theme="dark"] select {
    background: #1f2937;
    color: white;
    border-color: #4b5563;
  }
  button:hover { opacity: 0.9; }
  main { display: flex; max-width: 1100px; margin: 20px auto; gap: 20px; padding: 0 20px; }
  #chat-container { flex: 1; display: flex; flex-direction: column; }
  #chatbox {
    background: white; border: 1px solid #e5e7eb; border-radius: 12px;
    flex: 1; padding: 16px; overflow-y: auto;
    display: flex; flex-direction: column; gap: 12px;
    min-height: 400px;
  }
  [data-theme="dark"] #chatbox {
    background: #111827;
    border-color: #374151;
  }
  .message {
    padding: 12px 16px; border-radius: 12px; max-width: 85%;
    line-height: 1.5; animation: fadeIn 0.3s ease-out;
    word-wrap: break-word; white-space: pre-wrap;
    position: relative;
  }
  .user { background: var(--user-bg); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
  .bot { background: var(--bot-bg); color: var(--text); align-self: flex-start; border-bottom-left-radius: 4px; }
  .error { background: var(--error-bg); color: var(--error-text); align-self: center; text-align: center; }
  .typing { color: #6b7280; font-style: italic; animation: blink 1s steps(1) infinite; }
  @keyframes fadeIn { from {opacity:0;transform:translateY(10px);} to {opacity:1;transform:translateY(0);} }
  @keyframes blink { 50% {opacity:0.5;} }
  #input-container { display: flex; gap: 12px; margin-top: 12px; }
  #userInput {
    flex: 1; padding: 12px 16px; border: 1px solid #e5e7eb;
    border-radius: 12px; font-size: 16px; background: white;
  }
  [data-theme="dark"] #userInput {
    background: #1f2937;
    color: white;
    border-color: #4b5563;
  }
  #sendBtn {
    background: var(--primary); color: white; border: none;
    border-radius: 12px; padding: 0 24px; font-weight: 500;
    cursor: pointer; transition: background-color 0.2s;
  }
  #sendBtn:hover { background: #4338ca; }
  #sendBtn:disabled { background: #9ca3af; cursor: not-allowed; }
  aside {
    width: 250px; background: white; border: 1px solid #e5e7eb;
    border-radius: 12px; padding: 16px; display: flex;
    flex-direction: column; gap: 12px;
  }
  [data-theme="dark"] aside {
    background: #111827;
    border-color: #374151;
  }
  #newConversationBtn {
    background: var(--primary); color: white; border: none;
    border-radius: 12px; padding: 12px; font-weight: 600;
    cursor: pointer; transition: background-color 0.2s;
  }
  #newConversationBtn:hover { background: #4338ca; }
  #conversationList {
    overflow-y: auto; flex: 1;
    display: flex; flex-direction: column; gap: 8px;
  }
  .conversation-btn {
    background: #f3f4f6; border: none; border-radius: 8px;
    padding: 8px 12px; font-size: 14px; color: var(--text);
    text-align: left; white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis; cursor: pointer;
    transition: background-color 0.2s;
    position: relative;
  }
  [data-theme="dark"] .conversation-btn {
    background: #374151;
  }
  .conversation-btn:hover { background: var(--primary); color: white; }
  .conversation-btn.active { background: var(--primary); color: white; font-weight: 700; }
  .conversation-actions {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 4px;
  }
  .conversation-btn:hover .conversation-actions {
    display: flex;
  }
  .message-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 8px;
    gap: 8px;
  }
  .action-btn {
    background: var(--copy-bg);
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .user .action-btn {
    background: rgba(255, 255, 255, 0.2);
  }
  [data-theme="dark"] .action-btn {
    background: rgba(255, 255, 255, 0.1);
  }
  [data-theme="dark"] .user .action-btn {
    background: rgba(0, 0, 0, 0.2);
  }
  .action-btn:hover {
    background: rgba(0, 0, 0, 0.2);
  }
  .user .action-btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }
  .model-selector {
    margin-top: 12px;
    width: 100%;
  }
  .settings-panel {
    margin-top: 12px;
    padding: 12px;
    background: var(--bot-bg);
    border-radius: 8px;
  }
  .settings-title {
    font-weight: bold;
    margin-bottom: 8px;
  }
  .slider-container {
    margin: 12px 0;
  }
  .slider-label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }
  .slider-value {
    font-weight: bold;
  }
  input[type="range"] {
    width: 100%;
  }
  .token-count {
    font-size: 12px;
    color: #6b7280;
    text-align: right;
    margin-top: 4px;
  }
  [data-theme="dark"] .token-count {
    color: #9ca3af;
  }
  .system-prompt-container {
    margin-top: 12px;
  }
  #systemPrompt {
    width: 100%;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    background: white;
    font-family: inherit;
    resize: vertical;
    min-height: 60px;
  }
  [data-theme="dark"] #systemPrompt {
    background: #1f2937;
    color: white;
    border-color: #4b5563;
  }
  /* Barra de ferramentas */
  .toolbar {
    display: flex;
    gap: 8px;
    padding: 8px;
    background: var(--toolbar-bg);
    border-radius: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }
  .toolbar-btn {
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .toolbar-btn:hover {
    opacity: 0.9;
  }
  @media(max-width:768px) {
    main { flex-direction: column; }
    aside { width:100%; margin-bottom:20px; order:-1; }
    #chatbox { height:50vh; }
    #input-container { flex-direction:column; }
    #sendBtn { width:100%; }
    .conversation-actions {
      display: flex;
    }
    header div {
      gap: 4px;
    }
    button, select {
      padding: 6px;
      font-size: 12px;
    }
    .toolbar {
      justify-content: center;
    }
  }
</style>
</head>
<body>
<header>
  <h1>ViBot Plus</h1>
  <div>
    <button id="toggleTheme" aria-label="Alternar tema">üåì Tema</button>
    <button id="exportHistory" aria-label="Exportar hist√≥rico">üìÇ Exportar</button>
    <button id="importHistory" aria-label="Importar hist√≥rico">üìÅ Importar</button>
    <button id="settingsBtn" aria-label="Configura√ß√µes">‚öôÔ∏è Config</button>
  </div>
</header>

<main>
  <div id="chat-container">
    <div class="toolbar">
      <button class="toolbar-btn" id="generateEmailBtn">üìß Gerar E-mail</button>
      <button class="toolbar-btn" id="summarizeTextBtn">üìù Resumir Texto</button>
      <button class="toolbar-btn" id="translateTextBtn">üåê Traduzir</button>
      <button class="toolbar-btn" id="improveTextBtn">‚úçÔ∏è Melhorar Texto</button>
      <button class="toolbar-btn" id="generateCodeBtn">üíª Gerar C√≥digo</button>
    </div>
    <div id="chatbox" role="log" aria-live="polite" aria-atomic="false"></div>
    <div id="input-container">
      <input id="userInput" placeholder="Digite sua mensagem..." autocomplete="off" />
      <button id="sendBtn" aria-label="Enviar mensagem">üì© Enviar</button>
    </div>
  </div>
  <aside>
    <button id="newConversationBtn" aria-label="Nova conversa">‚ûï Nova Conversa</button>
    <div id="conversationList" aria-label="Lista de conversas"></div>
    
    <div class="settings-panel" id="settingsPanel" style="display: none;">
      <div class="settings-title">Configura√ß√µes do Modelo</div>
      
      <select id="modelSelector" class="model-selector">
        <option value="llama3-70b-8192">ViBot Pro (Alta Performance)</option>
        <option value="llama3-8b-8192">ViBot Standard (Balan√ßo)</option>
        <option value="mixtral-8x7b-32768">ViBot Expert (Conhecimento Avan√ßado)</option>
        <option value="gemma-7b-it">ViBot Lite (R√°pido e Leve)</option>
      </select>
      
      <div class="slider-container">
        <div class="slider-label">
          <span>Criatividade</span>
          <span class="slider-value" id="temperatureValue">0.7</span>
        </div>
        <input type="range" id="temperatureSlider" min="0" max="2" step="0.1" value="0.7" />
      </div>
      
      <div class="slider-container">
        <div class="slider-label">
          <span>Tamanho da Resposta</span>
          <span class="slider-value" id="maxTokensValue">1024</span>
        </div>
        <input type="range" id="maxTokensSlider" min="256" max="4096" step="128" value="1024" />
        <div class="token-count" id="tokenCount">Tokens usados: 0</div>
      </div>
      
      <div class="system-prompt-container">
        <div class="settings-title">Instru√ß√µes do Sistema</div>
        <textarea id="systemPrompt" placeholder="Como o assistente deve se comportar..."></textarea>
      </div>
    </div>
  </aside>
</main>

<input type="file" id="importFile" accept=".json,.txt" style="display: none;" aria-hidden="true" />

<script>
  const ViBot = {
    config: {
      apiUrl: "https://api.groq.com/openai/v1/chat/completions",
      apiKey: "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",
      model: "llama3-70b-8192",
      temperature: 0.7,
      maxTokens: 1024,
      systemPrompt: "Voc√™ √© um assistente √∫til chamado ViBot. Responda de forma clara e concisa no idioma do usu√°rio."
    },

    // Mapeamento dos modelos para nomes amig√°veis
    modelNames: {
      "llama3-70b-8192": "ViBot Pro (Alta Performance)",
      "llama3-8b-8192": "ViBot Standard (Balan√ßo)",
      "mixtral-8x7b-32768": "ViBot Expert (Conhecimento Avan√ßado)",
      "gemma-7b-it": "ViBot Lite (R√°pido e Leve)"
    },

    // Mapeamento reverso para obter o ID do modelo a partir do nome
    getModelIdByName(name) {
      for (const [id, modelName] of Object.entries(this.modelNames)) {
        if (modelName === name) return id;
      }
      return "llama3-70b-8192"; // padr√£o
    },

    init() {
      // Elementos principais
      this.chatbox = document.getElementById("chatbox");
      this.userInput = document.getElementById("userInput");
      this.sendBtn = document.getElementById("sendBtn");
      this.newConversationBtn = document.getElementById("newConversationBtn");
      this.conversationList = document.getElementById("conversationList");
      this.toggleThemeBtn = document.getElementById("toggleTheme");
      this.exportHistoryBtn = document.getElementById("exportHistory");
      this.importHistoryBtn = document.getElementById("importHistory");
      this.importFileInput = document.getElementById("importFile");
      this.settingsBtn = document.getElementById("settingsBtn");
      this.settingsPanel = document.getElementById("settingsPanel");
      this.modelSelector = document.getElementById("modelSelector");
      this.temperatureSlider = document.getElementById("temperatureSlider");
      this.temperatureValue = document.getElementById("temperatureValue");
      this.maxTokensSlider = document.getElementById("maxTokensSlider");
      this.maxTokensValue = document.getElementById("maxTokensValue");
      this.tokenCount = document.getElementById("tokenCount");
      this.systemPrompt = document.getElementById("systemPrompt");
      
      // Bot√µes da barra de ferramentas
      this.generateEmailBtn = document.getElementById("generateEmailBtn");
      this.summarizeTextBtn = document.getElementById("summarizeTextBtn");
      this.translateTextBtn = document.getElementById("translateTextBtn");
      this.improveTextBtn = document.getElementById("improveTextBtn");
      this.generateCodeBtn = document.getElementById("generateCodeBtn");

      // Vari√°veis de estado
      this.conversations = {};
      this.currentConversationId = null;
      this.totalTokens = 0;

      this.typingIndicator = document.createElement("div");
      this.typingIndicator.className = "message bot typing";
      this.typingIndicator.textContent = "ViBot est√° digitando...";

      this.loadTheme();
      this.loadSettings();
      this.loadConversations();

      if (!this.currentConversationId || !this.conversations[this.currentConversationId]) {
        this.createNewConversation();
      } else {
        this.renderConversationsList();
        this.renderCurrentConversation();
      }

      // Eventos principais
      this.sendBtn.onclick = () => this.sendMessage();
      this.userInput.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          this.sendMessage();
        }
      });
      this.newConversationBtn.onclick = () => this.createNewConversation();
      this.toggleThemeBtn.onclick = () => this.toggleTheme();
      this.exportHistoryBtn.onclick = () => this.exportHistory();
      this.importHistoryBtn.onclick = () => this.importFileInput.click();
      this.importFileInput.onchange = e => this.importHistory(e);
      this.settingsBtn.onclick = () => this.toggleSettings();
      this.modelSelector.onchange = e => this.updateModel(this.getModelIdByName(e.target.value));
      this.temperatureSlider.oninput = e => this.updateTemperature(e.target.value);
      this.maxTokensSlider.oninput = e => this.updateMaxTokens(e.target.value);
      this.systemPrompt.onchange = () => this.saveSettings();
      
      // Eventos da barra de ferramentas
      this.generateEmailBtn.onclick = () => this.generateEmail();
      this.summarizeTextBtn.onclick = () => this.summarizeText();
      this.translateTextBtn.onclick = () => this.translateText();
      this.improveTextBtn.onclick = () => this.improveText();
      this.generateCodeBtn.onclick = () => this.generateCode();

      this.userInput.focus();
    },

    loadTheme() {
      const theme = localStorage.getItem("vibot_theme") || "light";
      document.documentElement.setAttribute("data-theme", theme);
    },

    toggleTheme() {
      const currentTheme = document.documentElement.getAttribute("data-theme");
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", newTheme);
      localStorage.setItem("vibot_theme", newTheme);
    },

    loadSettings() {
      const settings = JSON.parse(localStorage.getItem("vibot_settings")) || {};
      
      if (settings.model) {
        this.config.model = settings.model;
        this.modelSelector.value = this.modelNames[settings.model] || this.modelNames["llama3-70b-8192"];
      }
      
      if (settings.temperature) {
        this.config.temperature = parseFloat(settings.temperature);
        this.temperatureSlider.value = this.config.temperature;
        this.temperatureValue.textContent = this.config.temperature;
      }
      
      if (settings.maxTokens) {
        this.config.maxTokens = parseInt(settings.maxTokens);
        this.maxTokensSlider.value = this.config.maxTokens;
        this.maxTokensValue.textContent = this.config.maxTokens;
      }
      
      if (settings.systemPrompt) {
        this.config.systemPrompt = settings.systemPrompt;
        this.systemPrompt.value = this.config.systemPrompt;
      }
    },

    saveSettings() {
      const settings = {
        model: this.config.model,
        temperature: this.config.temperature,
        maxTokens: this.config.maxTokens,
        systemPrompt: this.systemPrompt.value
      };
      
      localStorage.setItem("vibot_settings", JSON.stringify(settings));
      this.config.systemPrompt = this.systemPrompt.value;
    },

    updateModel(model) {
      this.config.model = model;
      this.saveSettings();
    },

    updateTemperature(value) {
      this.config.temperature = parseFloat(value);
      this.temperatureValue.textContent = value;
      this.saveSettings();
    },

    updateMaxTokens(value) {
      this.config.maxTokens = parseInt(value);
      this.maxTokensValue.textContent = value;
      this.saveSettings();
    },

    toggleSettings() {
      this.settingsPanel.style.display = this.settingsPanel.style.display === "none" ? "block" : "none";
    },

    loadConversations() {
      const saved = localStorage.getItem("vibot_conversations");
      if (saved) {
        try {
          this.conversations = JSON.parse(saved);
          this.currentConversationId = localStorage.getItem("vibot_currentConversation");
        } catch {
          this.conversations = {};
        }
      } else {
        this.conversations = {};
      }
    },

    saveConversations() {
      localStorage.setItem("vibot_conversations", JSON.stringify(this.conversations));
      localStorage.setItem("vibot_currentConversation", this.currentConversationId);
    },

    createNewConversation() {
      const id = "conv_" + Date.now();
      this.conversations[id] = {
        id,
        title: "Nova Conversa",
        messages: [],
        createdAt: Date.now()
      };
      
      this.currentConversationId = id;
      this.saveConversations();
      this.renderConversationsList();
      this.renderCurrentConversation();
      this.userInput.focus();
    },

    renderConversationsList() {
      this.conversationList.innerHTML = "";
      
      Object.values(this.conversations)
        .sort((a, b) => b.createdAt - a.createdAt)
        .forEach(conversation => {
          const btn = document.createElement("button");
          btn.className = `conversation-btn ${conversation.id === this.currentConversationId ? "active" : ""}`;
          btn.textContent = conversation.title;
          btn.onclick = () => this.switchConversation(conversation.id);
          
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "conversation-actions";
          
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "action-btn";
          deleteBtn.innerHTML = "üóëÔ∏è";
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            this.deleteConversation(conversation.id);
          };
          
          actionsDiv.appendChild(deleteBtn);
          btn.appendChild(actionsDiv);
          this.conversationList.appendChild(btn);
        });
    },

    switchConversation(id) {
      this.currentConversationId = id;
      this.saveConversations();
      this.renderConversationsList();
      this.renderCurrentConversation();
    },

    deleteConversation(id) {
      if (Object.keys(this.conversations).length <= 1) {
        this.createNewConversation();
      }
      
      delete this.conversations[id];
      this.saveConversations();
      
      if (id === this.currentConversationId) {
        const firstId = Object.keys(this.conversations)[0];
        this.switchConversation(firstId);
      } else {
        this.renderConversationsList();
      }
    },

    renderCurrentConversation() {
      this.chatbox.innerHTML = "";
      
      if (!this.currentConversationId || !this.conversations[this.currentConversationId]) {
        this.createNewConversation();
        return;
      }
      
      const conversation = this.conversations[this.currentConversationId];
      
      if (conversation.messages.length === 0) {
        this.addMessage("bot", "Ol√°! Sou o ViBot, seu assistente de IA. Como posso te ajudar hoje?");
      } else {
        conversation.messages.forEach(msg => {
          this.addMessageToChatbox(msg.role, msg.content, msg.type);
        });
      }
      
      this.chatbox.scrollTop = this.chatbox.scrollHeight;
    },

    async sendMessage() {
      const message = this.userInput.value.trim();
      if (!message) return;
      
      const conversation = this.conversations[this.currentConversationId];
      
      // Adiciona mensagem do usu√°rio
      this.addMessage("user", message);
      this.userInput.value = "";
      
      // Mostra indicador de digita√ß√£o
      this.chatbox.appendChild(this.typingIndicator);
      this.chatbox.scrollTop = this.chatbox.scrollHeight;
      
      try {
        // Prepara as mensagens para a API
        const messages = [
          { role: "system", content: this.config.systemPrompt },
          ...conversation.messages.map(msg => ({
            role: msg.role,
            content: this.getTextContent(msg.content)
          }))
        ];
        
        // Faz a requisi√ß√£o para a API do Groq
        const response = await fetch(this.config.apiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${this.config.apiKey}`
          },
          body: JSON.stringify({
            model: this.config.model,
            messages,
            temperature: this.config.temperature,
            max_tokens: this.config.maxTokens
          })
        });
        
        if (!response.ok) {
          throw new Error(`Erro na API: ${response.status}`);
        }
        
        const data = await response.json();
        const botMessage = data.choices[0].message.content;
        
        // Remove o indicador de digita√ß√£o e adiciona a resposta
        this.typingIndicator.remove();
        this.addMessage("bot", botMessage);
        
        // Atualiza contagem de tokens
        this.totalTokens += data.usage.total_tokens;
        this.tokenCount.textContent = `Tokens usados: ${this.totalTokens}`;
      } catch (error) {
        this.typingIndicator.remove();
        this.addMessage("bot", `Desculpe, ocorreu um erro: ${error.message}`, "error");
        console.error("Erro ao enviar mensagem:", error);
      }
    },

    addMessage(role, content, type = null) {
      const conversation = this.conversations[this.currentConversationId];
      const message = { role, content, type, timestamp: Date.now() };
      
      conversation.messages.push(message);
      
      // Atualiza t√≠tulo se for a primeira mensagem do usu√°rio
      if (role === "user" && conversation.messages.length === 1) {
        conversation.title = content.length > 30 ? content.substring(0, 30) + "..." : content;
      }
      
      this.saveConversations();
      this.renderConversationsList();
      this.addMessageToChatbox(role, content, type);
      this.chatbox.scrollTop = this.chatbox.scrollHeight;
    },

    addMessageToChatbox(role, content, type = null) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${role}`;
      if (type) messageDiv.classList.add(type);
      messageDiv.innerHTML = content;
      
      // Adiciona bot√µes de a√ß√£o
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "message-actions";
      
      // Bot√£o de copiar para todas as mensagens
      const copyBtn = document.createElement("button");
      copyBtn.className = "action-btn";
      copyBtn.innerHTML = "üìã Copiar";
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(this.getTextContent(content));
        copyBtn.innerHTML = "‚úì Copiado!";
        setTimeout(() => {
          copyBtn.innerHTML = "üìã Copiar";
        }, 2000);
      };
      actionsDiv.appendChild(copyBtn);
      
      messageDiv.appendChild(actionsDiv);
      this.chatbox.appendChild(messageDiv);
    },

    // Fun√ß√£o auxiliar para extrair texto de conte√∫do HTML
    getTextContent(html) {
      const temp = document.createElement('div');
      temp.innerHTML = html;
      return temp.textContent || temp.innerText || '';
    },

    exportHistory() {
      const data = {
        conversations: this.conversations,
        currentConversationId: this.currentConversationId,
        settings: {
          model: this.config.model,
          temperature: this.config.temperature,
          maxTokens: this.config.maxTokens,
          systemPrompt: this.config.systemPrompt
        }
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement("a");
      a.href = url;
      a.download = `vibot-history-${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      
      setTimeout(() => {
        URL.revokeObjectURL(url);
      }, 100);
    },

    importHistory(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          if (data.conversations) {
            this.conversations = data.conversations;
          }
          
          if (data.currentConversationId) {
            this.currentConversationId = data.currentConversationId;
          }
          
          if (data.settings) {
            if (data.settings.model) {
              this.config.model = data.settings.model;
              this.modelSelector.value = this.modelNames[data.settings.model] || this.modelNames["llama3-70b-8192"];
            }
            
            if (data.settings.temperature) {
              this.config.temperature = data.settings.temperature;
              this.temperatureSlider.value = data.settings.temperature;
              this.temperatureValue.textContent = data.settings.temperature;
            }
            
            if (data.settings.maxTokens) {
              this.config.maxTokens = data.settings.maxTokens;
              this.maxTokensSlider.value = data.settings.maxTokens;
              this.maxTokensValue.textContent = data.settings.maxTokens;
            }
            
            if (data.settings.systemPrompt) {
              this.config.systemPrompt = data.settings.systemPrompt;
              this.systemPrompt.value = data.settings.systemPrompt;
            }
            
            this.saveSettings();
          }
          
          this.saveConversations();
          this.renderConversationsList();
          this.renderCurrentConversation();
          
          this.addMessage("bot", "Hist√≥rico importado com sucesso!");
        } catch (error) {
          this.addMessage("bot", "Erro ao importar hist√≥rico. O arquivo pode estar corrompido.", "error");
          console.error("Erro ao importar hist√≥rico:", error);
        }
      };
      reader.readAsText(file);
    },
    
    // Fun√ß√µes da barra de ferramentas
    generateEmail() {
      const prompt = `Por favor, gere um e-mail profissional com base nas seguintes informa√ß√µes:
      
      - Assunto: 
      - Destinat√°rio: 
      - Mensagem principal: 
      - Tom (formal, informal, etc.): 
      
      Por favor, pe√ßa ao usu√°rio para fornecer esses detalhes antes de gerar o e-mail.`;
      
      this.addMessage("user", "Quero gerar um e-mail profissional");
      this.sendToolMessage(prompt);
    },
    
    summarizeText() {
      const prompt = `Por favor, resuma o seguinte texto mantendo os pontos principais. 
      O resumo deve ser conciso e claro. Aguardo o texto que voc√™ deseja resumir:`;
      
      this.addMessage("user", "Quero resumir um texto");
      this.sendToolMessage(prompt);
    },
    
    translateText() {
      const prompt = `Por favor, traduza o seguinte texto. 
      Informe o idioma de origem e o idioma de destino, seguido pelo texto a ser traduzido:`;
      
      this.addMessage("user", "Quero traduzir um texto");
      this.sendToolMessage(prompt);
    },
    
    improveText() {
      const prompt = `Por favor, revise e melhore o seguinte texto, tornando-o mais claro, conciso e profissional. 
      Aguardo o texto que voc√™ deseja melhorar:`;
      
      this.addMessage("user", "Quero melhorar um texto");
      this.sendToolMessage(prompt);
    },
    
    generateCode() {
      const prompt = `Por favor, gere c√≥digo com base nas seguintes especifica√ß√µes:
      
      - Linguagem de programa√ß√£o: 
      - Funcionalidade desejada: 
      - Requisitos espec√≠ficos: 
      
      Por favor, pe√ßa ao usu√°rio para fornecer esses detalhes antes de gerar o c√≥digo.`;
      
      this.addMessage("user", "Quero gerar um c√≥digo");
      this.sendToolMessage(prompt);
    },
    
    async sendToolMessage(prompt) {
      const conversation = this.conversations[this.currentConversationId];
      
      // Mostra indicador de digita√ß√£o
      this.chatbox.appendChild(this.typingIndicator);
      this.chatbox.scrollTop = this.chatbox.scrollHeight;
      
      try {
        // Prepara as mensagens para a API
        const messages = [
          { role: "system", content: this.config.systemPrompt },
          ...conversation.messages.map(msg => ({
            role: msg.role,
            content: this.getTextContent(msg.content)
          }))
        ];
        
        // Adiciona o prompt espec√≠fico da ferramenta
        messages.push({ role: "user", content: prompt });
        
        // Faz a requisi√ß√£o para a API do Groq
        const response = await fetch(this.config.apiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${this.config.apiKey}`
          },
          body: JSON.stringify({
            model: this.config.model,
            messages,
            temperature: this.config.temperature,
            max_tokens: this.config.maxTokens
          })
        });
        
        if (!response.ok) {
          throw new Error(`Erro na API: ${response.status}`);
        }
        
        const data = await response.json();
        const botMessage = data.choices[0].message.content;
        
        // Remove o indicador de digita√ß√£o e adiciona a resposta
        this.typingIndicator.remove();
        this.addMessage("bot", botMessage);
        
        // Atualiza contagem de tokens
        this.totalTokens += data.usage.total_tokens;
        this.tokenCount.textContent = `Tokens usados: ${this.totalTokens}`;
      } catch (error) {
        this.typingIndicator.remove();
        this.addMessage("bot", `Desculpe, ocorreu um erro: ${error.message}`, "error");
        console.error("Erro ao enviar mensagem:", error);
      }
    }
  };

  window.onload = () => ViBot.init();
</script>
</body>
</html>
