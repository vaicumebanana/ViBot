<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ViBot - Assistente Virtual</title>
  <style>
    :root {
      --primary: #4f46e5;
      --user-bg: #4f46e5;
      --bot-bg: #f3f4f6;
      --error-bg: #fee2e2;
      --text: #111827;
      --error-text: #dc2626;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
      margin: 0;
      padding: 0;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 32px;
      background-color: white;
      border-bottom: 1px solid #e5e7eb;
    }

    h1 {
      margin: 0;
      color: var(--primary);
    }

    #languageSelector {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    main {
      max-width: 900px;
      margin: 20px auto;
      display: flex;
      gap: 20px;
      padding: 0 20px;
    }

    #chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #chatbox {
      height: 65vh;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }

    .message {
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 85%;
      line-height: 1.5;
      animation: fadeIn 0.3s ease-out;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message.user {
      background: var(--user-bg);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message.bot {
      background: var(--bot-bg);
      color: var(--text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .message.error {
      background: var(--error-bg);
      color: var(--error-text);
      align-self: center;
      text-align: center;
    }

    .message.typing {
      color: #6b7280;
      font-style: italic;
      animation: blink 1s steps(1) infinite;
    }

    .message img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 12px;
      display: block;
      margin-top: 8px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes blink {
      50% { opacity: 0.5; }
    }

    #input-container {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    #userInput {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
    }

    #sendBtn, #generateImageBtn {
      padding: 0 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    #sendBtn:hover:not(:disabled),
    #generateImageBtn:hover:not(:disabled) {
      background: #4338ca;
    }

    #sendBtn:disabled,
    #generateImageBtn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    aside {
      width: 250px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: 65vh;
    }

    #newConversationBtn {
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    #newConversationBtn:hover {
      background: #4338ca;
    }

    #conversationList {
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .conversation-btn {
      background: #f3f4f6;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      text-align: left;
      font-size: 14px;
      color: var(--text);
      transition: background-color 0.2s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-btn:hover {
      background: var(--primary);
      color: white;
    }

    .conversation-btn.active {
      background: var(--primary);
      color: white;
      font-weight: 700;
    }

    /* üîΩ RESPONSIVIDADE */
    @media (max-width: 768px) {
      main {
        flex-direction: column;
      }

      aside {
        width: 100%;
        height: auto;
        order: -1;
        margin-bottom: 20px;
      }

      #chatbox {
        height: 50vh;
      }

      #input-container {
        flex-direction: column;
      }

      #sendBtn, #generateImageBtn {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      h1 {
        font-size: 20px;
      }

      #languageSelector {
        width: 100%;
      }

      #userInput {
        font-size: 14px;
      }

      .conversation-btn {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ViBot</h1>
    <select id="languageSelector" title="Selecione o idioma">
      <option value="pt" selected>Portugu√™s</option>
      <option value="en">English</option>
      <option value="es">Espa√±ol</option>
      <option value="zh">‰∏≠Êñá (Chin√™s)</option>
      <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
      <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (√Årabe)</option>
      <option value="fr">Fran√ßais (Franc√™s)</option>
      <option value="ru">–†—É—Å—Å–∫–∏–π (Russo)</option>
    </select>
  </header>

  <main>
    <div id="chat-container">
      <div id="chatbox" role="log" aria-live="polite" aria-relevant="additions"></div>
      <div id="input-container">
        <input type="text" id="userInput" placeholder="Digite sua mensagem..." autocomplete="off" aria-label="Digite sua mensagem"/>
        <button id="generateImageBtn" aria-label="Gerar imagem">Gerar Imagem</button>
        <button id="sendBtn" aria-label="Enviar mensagem">Enviar</button>
      </div>
    </div>

    <aside aria-label="Lista de conversas anteriores e nova conversa">
      <button id="newConversationBtn" aria-label="Nova conversa">+ Nova Conversa</button>
      <div id="conversationList" role="list" aria-label="Conversas anteriores">
        <!-- Conversas aparecer√£o aqui -->
      </div>
    </aside>
  </main>

  <script>
    const ViBot = {
      config: {
        apiUrl: "https://api.groq.com/openai/v1/chat/completions",
        apiKey: "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",
        model: "llama3-70b-8192",
        temperature: 0.7,
        maxTokens: 1024
      },

      replicateToken: "r8_M1Ic7mKU9eTZqMjWf6ucMW1ZkjF8sM74V6w56",

      DOM: {
        chatbox: null,
        input: null,
        sendBtn: null,
        generateImageBtn: null,
        newConversationBtn: null,
        conversationList: null,
        languageSelector: null,
        typingIndicator: null
      },

      currentConversationId: null,
      conversations: {},

      init() {
        this.DOM.chatbox = document.getElementById("chatbox");
        this.DOM.input = document.getElementById("userInput");
        this.DOM.sendBtn = document.getElementById("sendBtn");
        this.DOM.generateImageBtn = document.getElementById("generateImageBtn");
        this.DOM.newConversationBtn = document.getElementById("newConversationBtn");
        this.DOM.conversationList = document.getElementById("conversationList");
        this.DOM.languageSelector = document.getElementById("languageSelector");

        this.DOM.typingIndicator = document.createElement("div");
        this.DOM.typingIndicator.className = "message bot typing";
        this.DOM.typingIndicator.textContent = "ViBot est√° digitando...";

        this.loadConversations();

        if (!this.currentConversationId) {
          this.createNewConversation();
        } else {
          this.renderConversationsList();
          this.renderCurrentConversation();
        }

        this.DOM.sendBtn.addEventListener("click", () => this.sendMessage());
        this.DOM.input.addEventListener("keydown", e => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });
        this.DOM.generateImageBtn.addEventListener("click", () => this.generateImageFromPrompt());

        this.DOM.newConversationBtn.addEventListener("click", () => this.createNewConversation());

        this.DOM.languageSelector.addEventListener("change", () => {
          // Pode implementar mudan√ßa de idioma aqui, ou enviar idioma no prompt
        });
      },

      // Cria conversa nova
      createNewConversation() {
        const id = "conv_" + Date.now();
        this.conversations[id] = [];
        this.currentConversationId = id;
        this.saveConversations();
        this.renderConversationsList();
        this.renderCurrentConversation();
        this.DOM.input.focus();
      },

      // Salva no localStorage
      saveConversations() {
        localStorage.setItem("vibot_conversations", JSON.stringify(this.conversations));
        localStorage.setItem("vibot_current", this.currentConversationId);
      },

      // Carrega do localStorage
      loadConversations() {
        const conv = localStorage.getItem("vibot_conversations");
        if (conv) {
          this.conversations = JSON.parse(conv);
          this.currentConversationId = localStorage.getItem("vibot_current") || Object.keys(this.conversations)[0];
        }
      },

      // Renderiza lista lateral de conversas
      renderConversationsList() {
        this.DOM.conversationList.innerHTML = "";
        for (const id of Object.keys(this.conversations).reverse()) {
          const btn = document.createElement("button");
          btn.className = "conversation-btn" + (id === this.currentConversationId ? " active" : "");
          btn.textContent = this.getConversationTitle(this.conversations[id]) || "Nova Conversa";
          btn.title = "Abrir conversa";
          btn.addEventListener("click", () => {
            this.currentConversationId = id;
            this.saveConversations();
            this.renderConversationsList();
            this.renderCurrentConversation();
          });
          this.DOM.conversationList.appendChild(btn);
        }
      },

      // Gera um t√≠tulo simples da conversa
      getConversationTitle(messages) {
        for (const m of messages) {
          if (m.role === "user") {
            return m.content.length > 20 ? m.content.slice(0, 20) + "..." : m.content;
          }
        }
        return "";
      },

      // Renderiza conversa atual
      renderCurrentConversation() {
        this.DOM.chatbox.innerHTML = "";
        const conv = this.conversations[this.currentConversationId];
        if (!conv) return;

        for (const msg of conv) {
          if (msg.type === "image") {
            this.addImageMessage(msg.content);
          } else if (msg.type === "image-array") {
            try {
              const urls = JSON.parse(msg.content);
              this.addImagesMessages(urls);
            } catch {
              this.addMessage("Erro ao carregar imagens", "error");
            }
          } else if (msg.role === "error") {
            this.addMessage(msg.content, "error");
          } else {
            this.addMessage(msg.content, msg.role);
          }
        }
      },

      // Adiciona mensagem simples texto
      addMessage(text, role) {
        const msg = document.createElement("div");
        msg.className = "message " + (role === "user" ? "user" : role === "bot" ? "bot" : "error");
        msg.textContent = text;
        this.DOM.chatbox.appendChild(msg);
        this.DOM.chatbox.scrollTop = this.DOM.chatbox.scrollHeight;
      },

      // Adiciona uma imagem √∫nica como mensagem bot
      addImageMessage(url) {
        const msg = document.createElement("div");
        msg.className = "message bot";
        const img = document.createElement("img");
        img.src = url;
        img.alt = "Imagem gerada";
        msg.appendChild(img);
        this.DOM.chatbox.appendChild(msg);
        this.DOM.chatbox.scrollTop = this.DOM.chatbox.scrollHeight;
      },

      // Adiciona m√∫ltiplas imagens como mensagens bot
      addImagesMessages(urls) {
        urls.forEach(url => {
          const msg = document.createElement("div");
          msg.className = "message bot";
          const img = document.createElement("img");
          img.src = url;
          img.alt = "Imagem gerada";
          msg.appendChild(img);
          this.DOM.chatbox.appendChild(msg);
        });
        this.DOM.chatbox.scrollTop = this.DOM.chatbox.scrollHeight;
      },

      // Envia mensagem texto para API do chatbot (OpenAI via Groq)
      async sendMessage() {
        const prompt = this.DOM.input.value.trim();
        if (!prompt) return;

        this.DOM.sendBtn.disabled = true;
        this.DOM.generateImageBtn.disabled = true;

        this.addMessage(prompt, "user");
        this.conversations[this.currentConversationId].push({ role: "user", content: prompt });
        this.saveConversations();

        this.DOM.chatbox.appendChild(this.DOM.typingIndicator);
        this.DOM.chatbox.scrollTop = this.DOM.chatbox.scrollHeight;

        try {
          const lang = this.DOM.languageSelector.value;
          const systemPrompt = this.getSystemPrompt(lang);

          // Monta o hist√≥rico para enviar
          const messages = [
            { role: "system", content: systemPrompt },
            ...this.conversations[this.currentConversationId]
          ];

          const response = await fetch(this.config.apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${this.config.apiKey}`
            },
            body: JSON.stringify({
              model: this.config.model,
              messages: messages,
              max_tokens: this.config.maxTokens,
              temperature: this.config.temperature
            })
          });

          if (!response.ok) {
            throw new Error("Erro na API de chat");
          }

          const data = await response.json();

          const botReply = data.choices?.[0]?.message?.content?.trim();
          if (!botReply) throw new Error("Resposta vazia");

          this.DOM.chatbox.removeChild(this.DOM.typingIndicator);

          this.addMessage(botReply, "bot");
          this.conversations[this.currentConversationId].push({ role: "bot", content: botReply });
          this.saveConversations();
        } catch (error) {
          this.DOM.chatbox.removeChild(this.DOM.typingIndicator);
          this.addMessage("Erro: " + error.message, "error");
          this.conversations[this.currentConversationId].push({ role: "error", content: "Erro: " + error.message });
          this.saveConversations();
          console.error("ViBot Error:", error);
        } finally {
          this.DOM.sendBtn.disabled = false;
          this.DOM.generateImageBtn.disabled = false;
          this.DOM.input.value = "";
          this.DOM.input.focus();
          this.renderConversationsList();
        }
      },

      // Gera imagem usando Replicate minimax/image-01
      async generateImageFromPrompt() {
        const prompt = this.DOM.input.value.trim();
        if (!prompt) return;

        this.DOM.sendBtn.disabled = true;
        this.DOM.generateImageBtn.disabled = true;

        this.addMessage(prompt, "user");
        this.conversations[this.currentConversationId].push({ role: "user", content: prompt });
        this.saveConversations();

        this.DOM.chatbox.appendChild(this.DOM.typingIndicator);
        this.DOM.chatbox.scrollTop = this.DOM.chatbox.scrollHeight;

        try {
          const imageUrls = await this.callImageAPI(prompt);
          this.DOM.chatbox.removeChild(this.DOM.typingIndicator);

          this.addImagesMessages(imageUrls);

          // Salva o array de urls em string JSON na conversa
          this.conversations[this.currentConversationId].push({
            role: "bot",
            content: JSON.stringify(imageUrls),
            type: "image-array"
          });
          this.saveConversations();
        } catch (error) {
          this.DOM.chatbox.removeChild(this.DOM.typingIndicator);
          this.addMessage("Erro: " + error.message, "error");
          this.conversations[this.currentConversationId].push({ role: "error", content: "Erro: " + error.message });
          this.saveConversations();
          console.error("ViBot Image Error:", error);
        } finally {
          this.DOM.sendBtn.disabled = false;
          this.DOM.generateImageBtn.disabled = false;
          this.DOM.input.value = "";
          this.DOM.input.focus();
          this.renderConversationsList();
        }
      },

      // Chama API Replicate para gerar imagem
      async callImageAPI(prompt) {
        // Vers√£o correta do minimax/image-01 - confirme no site replicate.com/models/minimax/image-01
        const version = JSJAO;

        const input = {
          prompt: prompt,
          aspect_ratio: "3:4"
        };

        const response = await fetch("https://api.replicate.com/v1/predictions", {
          method: "POST",
          headers: {
            "Authorization": "Token " + this.replicateToken,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            version: version,
            input: input
          })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.detail || "Erro ao gerar imagem");
        }

        const prediction = await response.json();

        // Aguarda resultado com polling
        return await this.waitForPrediction(prediction.urls.get);
      },

      async waitForPrediction(url) {
        while (true) {
          const response = await fetch(url, {
            headers: {
              "Authorization": "Token " + this.replicateToken
            }
          });
          const prediction = await response.json();

          if (prediction.status === "succeeded") {
            return prediction.output; // Array de URLs das imagens
          } else if (prediction.status === "failed") {
            throw new Error("Falha na gera√ß√£o da imagem");
          }
          await new Promise(r => setTimeout(r, 1000));
        }
      },

      // Retorna prompt do sistema para cada idioma (exemplo simples)
      getSystemPrompt(lang) {
        switch (lang) {
          case "en": return "You are a helpful assistant.";
          case "es": return "Eres un asistente √∫til.";
          case "zh": return "‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÂ∏ÆÂä©ÁöÑÂä©Êâã„ÄÇ";
          case "hi": return "‡§Ü‡§™ ‡§è‡§ï ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§π‡•à‡§Ç‡•§";
          case "ar": return "ÿ£ŸÜÿ™ ŸÖÿ≥ÿßÿπÿØ ŸÖŸÅŸäÿØ.";
          case "fr": return "Vous √™tes un assistant utile.";
          case "ru": return "–í—ã –ø–æ–ª–µ–∑–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫.";
          default: return "Voc√™ √© um assistente √∫til.";
        }
      }
    };

    window.addEventListener("DOMContentLoaded", () => ViBot.init());
  </script>
</body>
</html>

