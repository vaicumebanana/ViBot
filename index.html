<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ViBot - Assistente Virtual</title>
<style>
  :root {
    --primary: #4f46e5;
    --user-bg: #4f46e5;
    --bot-bg: #f3f4f6;
    --error-bg: #fee2e2;
    --text: #111827;
    --error-text: #dc2626;
    --bg: #f9fafb;
  }
  [data-theme="dark"] {
    --bg: #1f2937;
    --bot-bg: #374151;
    --text: #f9fafb;
  }
  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0; padding: 0;
    transition: background 0.3s, color 0.3s;
  }
  header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 32px; background: white; border-bottom: 1px solid #e5e7eb;
  }
  [data-theme="dark"] header { background: #111827; }
  h1 { margin: 0; color: var(--primary); }
  header div { display: flex; align-items: center; gap: 8px; }
  button, select {
    font-size: 14px;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    background: white;
    cursor: pointer;
  }
  button:hover { opacity: 0.9; }
  main { display: flex; max-width: 1100px; margin: 20px auto; gap: 20px; padding: 0 20px; }
  #chat-container { flex: 1; display: flex; flex-direction: column; }
  #chatbox {
    background: white; border: 1px solid #e5e7eb; border-radius: 12px;
    flex: 1; padding: 16px; overflow-y: auto;
    display: flex; flex-direction: column; gap: 12px;
  }
  .message {
    padding: 12px 16px; border-radius: 12px; max-width: 85%;
    line-height: 1.5; animation: fadeIn 0.3s ease-out;
    word-wrap: break-word; white-space: pre-wrap;
    position: relative;
  }
  .user { background: var(--user-bg); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
  .bot { background: var(--bot-bg); color: var(--text); align-self: flex-start; border-bottom-left-radius: 4px; }
  .error { background: var(--error-bg); color: var(--error-text); align-self: center; text-align: center; }
  .typing { color: #6b7280; font-style: italic; animation: blink 1s steps(1) infinite; }
  @keyframes fadeIn { from {opacity:0;transform:translateY(10px);} to {opacity:1;transform:translateY(0);} }
  @keyframes blink { 50% {opacity:0.5;} }
  #input-container { display: flex; gap: 12px; margin-top: 12px; }
  #userInput {
    flex: 1; padding: 12px 16px; border: 1px solid #e5e7eb;
    border-radius: 12px; font-size: 16px;
  }
  #sendBtn {
    background: var(--primary); color: white; border: none;
    border-radius: 12px; padding: 0 24px; font-weight: 500;
    cursor: pointer; transition: background-color 0.2s;
  }
  #sendBtn:hover { background: #4338ca; }
  #sendBtn:disabled { background: #9ca3af; cursor: not-allowed; }
  aside {
    width: 250px; background: white; border: 1px solid #e5e7eb;
    border-radius: 12px; padding: 16px; display: flex;
    flex-direction: column; gap: 12px;
  }
  #newConversationBtn {
    background: var(--primary); color: white; border: none;
    border-radius: 12px; padding: 12px; font-weight: 600;
    cursor: pointer; transition: background-color 0.2s;
  }
  #newConversationBtn:hover { background: #4338ca; }
  #conversationList {
    overflow-y: auto; flex: 1;
    display: flex; flex-direction: column; gap: 8px;
  }
  .conversation-btn {
    background: #f3f4f6; border: none; border-radius: 8px;
    padding: 8px 12px; font-size: 14px; color: var(--text);
    text-align: left; white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis; cursor: pointer;
    transition: background-color 0.2s;
  }
  .conversation-btn:hover { background: var(--primary); color: white; }
  .conversation-btn.active { background: var(--primary); color: white; font-weight: 700; }
  @media(max-width:768px) {
    main { flex-direction: column; }
    aside { width:100%; margin-bottom:20px; order:-1; }
    #chatbox { height:50vh; }
    #input-container { flex-direction:column; }
    #sendBtn { width:100%; }
  }
</style>
</head>
<body>
<header>
  <h1>ViBot</h1>
  <div>
    <button id="toggleTheme" aria-label="Alternar tema">üåì Tema</button>
    <button id="startSpeech" aria-label="Ativar/desativar voz">üéôÔ∏è Voz</button>
    <button id="exportHistory" aria-label="Exportar hist√≥rico">üìÇ Exportar</button>
    <button id="importHistory" aria-label="Importar hist√≥rico">üìÅ Importar</button>
    <button id="clearConversation" aria-label="Apagar conversa atual">üóëÔ∏è Apagar</button>
    <select id="languageSelector" aria-label="Selecionar idioma">
      <option value="pt-BR" selected>Portugu√™s</option>
      <option value="en-US">English</option>
      <option value="es">Espa√±ol</option>
      <option value="zh">‰∏≠Êñá</option>
      <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
      <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
      <option value="fr">Fran√ßais</option>
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
    </select>
  </div>
</header>

<main>
  <div id="chat-container">
    <div id="chatbox" role="log" aria-live="polite" aria-atomic="false"></div>
    <div id="input-container">
      <input id="userInput" placeholder="Digite sua mensagem..." autocomplete="off" />
      <button id="sendBtn" aria-label="Enviar mensagem">üì© Enviar</button>
    </div>
  </div>
  <aside>
    <button id="newConversationBtn" aria-label="Nova conversa">‚ûï Nova Conversa</button>
    <div id="conversationList" aria-label="Lista de conversas"></div>
  </aside>
</main>

<input type="file" id="importFile" accept=".txt" style="display: none;" aria-hidden="true" />

<script>
  const ViBot = {
    config: {
      // Use seu endpoint real e chave API
      apiUrl: "https://api.groq.com/openai/v1/chat/completions",
      apiKey: "gsk_GAB1Wl5zqbp30qPDeMObWGdyb3FY0g7KiTlGt5aWhUnkD495Bi3T",
      model: "llama3-70b-8192",
      temperature: 0.7,
      maxTokens: 1024
    },

    init() {
      // Elementos
      this.chatbox = document.getElementById("chatbox");
      this.userInput = document.getElementById("userInput");
      this.sendBtn = document.getElementById("sendBtn");
      this.newConversationBtn = document.getElementById("newConversationBtn");
      this.conversationList = document.getElementById("conversationList");
      this.languageSelector = document.getElementById("languageSelector");
      this.toggleThemeBtn = document.getElementById("toggleTheme");
      this.startSpeechBtn = document.getElementById("startSpeech");
      this.exportHistoryBtn = document.getElementById("exportHistory");
      this.importHistoryBtn = document.getElementById("importHistory");
      this.importFileInput = document.getElementById("importFile");
      this.clearConversationBtn = document.getElementById("clearConversation");

      this.speaking = false;
      this.speechSynthesis = window.speechSynthesis;
      this.currentUtterance = null;

      // Para garantir que as vozes sejam carregadas
      window.speechSynthesis.onvoiceschanged = () => {};

      this.typingIndicator = document.createElement("div");
      this.typingIndicator.className = "message bot typing";
      this.typingIndicator.textContent = "ViBot est√° digitando...";

      this.loadTheme();
      this.loadConversations();

      if (!this.currentConversationId || !this.conversations[this.currentConversationId]) {
        this.createNewConversation();
      } else {
        this.renderConversationsList();
        this.renderCurrentConversation();
      }

      // Eventos
      this.sendBtn.onclick = () => this.sendMessage();
      this.userInput.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          this.sendMessage();
        }
      });
      this.newConversationBtn.onclick = () => this.createNewConversation();
      this.toggleThemeBtn.onclick = () => this.toggleTheme();
      this.startSpeechBtn.onclick = () => this.toggleSpeech();
      this.exportHistoryBtn.onclick = () => this.exportHistory();
      this.importHistoryBtn.onclick = () => this.importFileInput.click();
      this.importFileInput.onchange = e => this.importHistory(e);
      this.languageSelector.onchange = e => this.changeLanguage(e.target.value);
      this.clearConversationBtn.onclick = () => this.clearConversation();

      // Bot√£o enviar sempre habilitado (removemos disables)
      this.sendBtn.disabled = false;
      this.userInput.disabled = false;

      this.userInput.focus();
    },

    conversations: {},
    currentConversationId: null,

    loadConversations() {
      const data = localStorage.getItem("vibot_conversations");
      if (data) {
        try {
          this.conversations = JSON.parse(data);
          this.currentConversationId = localStorage.getItem("vibot_currentConversationId");
        } catch {
          this.conversations = {};
          this.currentConversationId = null;
        }
      }
    },

    saveConversations() {
      localStorage.setItem("vibot_conversations", JSON.stringify(this.conversations));
      if (this.currentConversationId) localStorage.setItem("vibot_currentConversationId", this.currentConversationId);
    },

    createNewConversation() {
      const id = "conv-" + Date.now();
      this.conversations[id] = { id, title: "Nova conversa", messages: [] };
      this.currentConversationId = id;
      this.saveConversations();
      this.renderConversationsList();
      this.renderCurrentConversation();
      this.userInput.focus();
    },

    renderConversationsList() {
      this.conversationList.innerHTML = "";
      for (const id in this.conversations) {
        const conv = this.conversations[id];
        const btn = document.createElement("button");
        btn.textContent = conv.title || "Sem t√≠tulo";
        btn.className = "conversation-btn" + (id === this.currentConversationId ? " active" : "");
        btn.onclick = () => {
          this.currentConversationId = id;
          this.saveConversations();
          this.renderConversationsList();
          this.renderCurrentConversation();
          this.userInput.focus();
        };
        this.conversationList.appendChild(btn);
      }
    },

    renderCurrentConversation() {
      if (!this.currentConversationId || !this.conversations[this.currentConversationId]) return;
      const conv = this.conversations[this.currentConversationId];
      this.chatbox.innerHTML = "";
      for (const msg of conv.messages) {
        this.appendMessageToChatbox(msg.role, msg.content);
      }
      this.scrollToBottom();
      this.userInput.value = "";
    },

    appendMessageToChatbox(role, content) {
      const div = document.createElement("div");
      div.className = "message " + (role === "user" ? "user" : "bot");
      div.textContent = content;

      if (role === "bot") {
        // Bot√£o TTS pequeno
        const ttsBtn = document.createElement("button");
        ttsBtn.textContent = "üîä";
        ttsBtn.style.cssText = "position:absolute;top:4px;right:6px;cursor:pointer;background:none;border:none;font-size:18px;";
        ttsBtn.title = "Ouvir mensagem";
        ttsBtn.onclick = (e) => {
          e.stopPropagation();
          this.speakText(content);
        };
        div.style.position = "relative";
        div.appendChild(ttsBtn);
      }
      this.chatbox.appendChild(div);
    },

    scrollToBottom() {
      this.chatbox.scrollTop = this.chatbox.scrollHeight;
    },

    sendMessage() {
      let text = this.userInput.value.trim();
      if (!text) return;
      this.addMessage("user", text);
      this.userInput.value = "";
      this.processBotResponse(text);
    },

    addMessage(role, content) {
      const conv = this.conversations[this.currentConversationId];
      conv.messages.push({ role, content });
      this.saveConversations();
      this.appendMessageToChatbox(role, content);
      this.scrollToBottom();
    },

    async processBotResponse(userText) {
      // Mostrar indicador de digita√ß√£o
      this.chatbox.appendChild(this.typingIndicator);
      this.scrollToBottom();

      try {
        const response = await fetch(this.config.apiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${this.config.apiKey}`,
          },
          body: JSON.stringify({
            model: this.config.model,
            messages: this.conversations[this.currentConversationId].messages,
            temperature: this.config.temperature,
            max_tokens: this.config.maxTokens,
          }),
        });

        if (!response.ok) {
          throw new Error("Erro na API: " + response.statusText);
        }
        const data = await response.json();

        // Remove indicador de digita√ß√£o
        if (this.typingIndicator.parentNode) {
          this.typingIndicator.parentNode.removeChild(this.typingIndicator);
        }

        let botReply = "";
        if (data.choices && data.choices.length > 0) {
          botReply = data.choices[0].message.content;
        } else {
          botReply = "Desculpe, n√£o consegui entender. Pode tentar novamente?";
        }
        this.addMessage("bot", botReply);

        // Falar
        this.speakText(botReply);

      } catch (error) {
        if (this.typingIndicator.parentNode) {
          this.typingIndicator.parentNode.removeChild(this.typingIndicator);
        }
        this.addMessage("bot", "Erro ao obter resposta do servidor.");
        console.error(error);
      }
    },

    speakText(text) {
      if (!this.speechSynthesis) return;
      if (this.speechSynthesis.speaking) {
        this.speechSynthesis.cancel();
      }
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = this.languageSelector.value || "pt-BR";
      // Ajuste de velocidade para voz mais natural
      utterance.rate = 0.9;

      // Selecionar voz que combina com o idioma
      const voices = this.speechSynthesis.getVoices();
      let voice = voices.find(v => v.lang.startsWith(utterance.lang));
      if (!voice) voice = voices[0];
      if (voice) utterance.voice = voice;

      this.speechSynthesis.speak(utterance);
      this.currentUtterance = utterance;
    },

    toggleSpeech() {
      if (!this.speechSynthesis) return;
      if (this.speechSynthesis.speaking) {
        this.speechSynthesis.cancel();
        this.startSpeechBtn.textContent = "üéôÔ∏è Voz";
      } else {
        // Repetir √∫ltima mensagem do bot
        const conv = this.conversations[this.currentConversationId];
        if (!conv || conv.messages.length === 0) return;
        const lastBotMsg = [...conv.messages].reverse().find(m => m.role === "bot");
        if (!lastBotMsg) return;
        this.speakText(lastBotMsg.content);
        this.startSpeechBtn.textContent = "üõë Parar";
      }
    },

    exportHistory() {
      const conv = this.conversations[this.currentConversationId];
      if (!conv) return;
      const text = conv.messages.map(m => `${m.role === "user" ? "Usu√°rio" : "ViBot"}: ${m.content}`).join("\n\n");
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `vibot_conversa_${Date.now()}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    },

    importHistory(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const text = e.target.result;
        // Importa como uma nova conversa com t√≠tulo "Importada"
        const id = "conv-" + Date.now();
        this.conversations[id] = { id, title: "Importada", messages: [] };

        // Parse simples: cada linha "Usu√°rio: texto" ou "ViBot: texto"
        const lines = text.split(/\r?\n/);
        for (let line of lines) {
          line = line.trim();
          if (!line) continue;
          let role = null;
          let content = null;
          if (line.startsWith("Usu√°rio:")) {
            role = "user";
            content = line.replace(/^Usu√°rio:\s*/, "");
          } else if (line.startsWith("ViBot:")) {
            role = "bot";
            content = line.replace(/^ViBot:\s*/, "");
          }
          if (role && content) this.conversations[id].messages.push({ role, content });
        }
        this.currentConversationId = id;
        this.saveConversations();
        this.renderConversationsList();
        this.renderCurrentConversation();
      };
      reader.readAsText(file);
      // Resetar input para poder importar novamente o mesmo arquivo se quiser
      this.importFileInput.value = "";
    },

    changeLanguage(lang) {
      // S√≥ atualiza o select, a fala j√° respeita este valor
    },

    toggleTheme() {
      if (document.documentElement.getAttribute("data-theme") === "dark") {
        document.documentElement.removeAttribute("data-theme");
        localStorage.removeItem("vibot_theme");
      } else {
        document.documentElement.setAttribute("data-theme", "dark");
        localStorage.setItem("vibot_theme", "dark");
      }
    },

    loadTheme() {
      const theme = localStorage.getItem("vibot_theme");
      if (theme === "dark") {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    },

    clearConversation() {
      if (!this.currentConversationId) return;
      if (confirm("Tem certeza que deseja apagar toda a conversa atual? Essa a√ß√£o n√£o pode ser desfeita.")) {
        this.conversations[this.currentConversationId].messages = [];
        this.saveConversations();
        this.renderCurrentConversation();
        this.userInput.focus();
      }
    },
  };

  window.onload = () => ViBot.init();
</script>
</body>
</html>
